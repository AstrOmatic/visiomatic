/*
#	Copyright:		(C) 2013 Emmanuel Bertin - IAP/CNRS/UPMC
#                        Chiara Marmo - IDES/Paris-Sud,
#                        Ruven Pillay - C2RMF/CNRS
#
#	License:		GNU General Public License
#
#	This Leaflet plug-in is free software: you can redistribute it and/or modify
#	it under the terms of the GNU General Public License as published by
#	the Free Software Foundation, either version 3 of the License, or
# 	(at your option) any later version.
#	This plug-in is distributed in the hope that it will be useful,
#	but WITHOUT ANY WARRANTY; without even the implied warranty of
#	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#	GNU General Public License for more details.
#	You should have received a copy of the GNU General Public License
#	along with this plug-in. If not, see <http://www.gnu.org/licenses/>.
*/

!function(t,i,e){L.Projection.WCS={_phiThetaToRADec:function(t,i){var e=L.LatLng.DEG_TO_RAD,a=L.LatLng.RAD_TO_DEG,o=t.lat*e,n=Math.cos(o),r=Math.sin(o),s=i.celpole.lat*e,l=Math.cos(s),h=Math.sin(s),p=(t.lng-i.natpole.lng)*e,c=Math.cos(p);return new L.LatLng(Math.asin(r*h+n*l*c)*a,i.celpole.lng+Math.atan2(-n*Math.sin(p),r*l-n*h*c)*a)},_raDecToPhiTheta:function(t,i){var e=L.LatLng.DEG_TO_RAD,a=L.LatLng.RAD_TO_DEG,o=(t.lng-i.celpole.lng)*e,n=Math.cos(o),r=Math.sin(o),s=t.lat*e,l=Math.cos(s),h=Math.sin(s),p=i.celpole.lat*e,c=Math.cos(p),u=Math.sin(p);return new L.LatLng(Math.asin(h*u+l*c*n)*a,i.natpole.lng+Math.atan2(-l*r,h*c-l*u*n)*a)},_pixToRed:function(t,i){var e=i.cd,a=t.subtract(i.crpix);return new L.Point(a.x*e[0][0]+a.y*e[0][1],a.x*e[1][0]+a.y*e[1][1])},_redToPix:function(t,i){var e=i.cdinv;return new L.point(t.x*e[0][0]+t.y*e[0][1],t.x*e[1][0]+t.y*e[1][1]).add(i.crpix)},_invertCD:function(t){var i=1/(t[0][0]*t[1][1]-t[0][1]*t[1][0]);return[[t[1][1]*i,-t[0][1]*i],[-t[1][0]*i,t[0][0]*i]]}},L.Projection.WCS.zenithal=L.extend({},L.Projection.WCS,{paraminit:function(t){t.cdinv=this._invertCD(t.cd),t.natfid=new L.LatLng(0,90),t.celpole=t.crval},project:function(t,i){var e=this._raDecToPhiTheta(t,i);return e.lat=i.projection.thetaToR(e.lat),this._redToPix(this._phiRToRed(e),i)},unproject:function(t,i){var e=this._redToPhiR(this._pixToRed(t,i));return e.lat=i.projection.rToTheta(e.lat),this._phiThetaToRADec(e,i)},_redToPhiR:function(t){return new L.LatLng(Math.sqrt(t.x*t.x+t.y*t.y),Math.atan2(t.x,-t.y)*L.LatLng.RAD_TO_DEG)},_phiRToRed:function(t){var i=L.LatLng.DEG_TO_RAD,e=t.lng*i;return new L.Point(t.lat*Math.sin(e),-t.lat*Math.cos(e))}}),L.Projection.WCS.TAN=L.extend({},L.Projection.WCS.zenithal,{code:"TAN",rToTheta:function(t){return Math.atan2(180,Math.PI*t)*L.LatLng.RAD_TO_DEG},thetaToR:function(t){return 180/Math.PI*Math.tan((90-t)*L.LatLng.DEG_TO_RAD)}}),L.Projection.WCS.ZEA=L.extend({},L.Projection.WCS.zenithal,{code:"ZEA",rToTheta:function(t){return 90-2*Math.asin(Math.PI*t/360)*L.LatLng.RAD_TO_DEG},thetaToR:function(t){return 360/Math.PI*Math.sin(.5*(90-t)*L.LatLng.DEG_TO_RAD)}}),L.CRS.WCS=L.extend({},L.CRS,{projparam:{projection:L.Projection.WCS.TAN,ctype:{x:"RA--TAN",y:"DEC--TAN"},naxis:new L.point(256,256,!0),nzoom:1,crpix:L.point(129,129),crval:L.latLng(0,0),cd:[[1,0],[0,1]],natpole:L.latLng(90,180),tileSize:L.point(256,256),celpole:L.latLng(0,0),natfid:L.latLng(0,90),cdinv:[[1,0],[0,1]]},initialize:function(){var t=this.projparam;this.transformation=new L.Transformation(1,-1,-1,t.naxis.y),t.projection.paraminit(t),this.code+=":"+t.projection.code,this.ready=!0},code:"WCS",projection:L.Projection.WCS,latLngToPoint:function(t,i){this.ready||this.initialize();var e=this.projparam.projection.project(t,this.projparam),a=this.scale(i);return this.transformation._transform(e,a)},pointToLatLng:function(t,i){this.ready||this.initialize();var e=this.scale(i),a=this.transformation.untransform(t,e);return this.projparam.projection.unproject(a,this.projparam)},project:function(t){return this.ready||this.initialize(),this.projparam.projection.project(t,this.projparam)},scale:function(t){return Math.pow(2,t-this.projparam.nzoom+1)},zoom1:function(t,i){return Math.ceil(Math.log(Math.max(t.x/i.x,t.y/i.y))/Math.LN2)}}),L.TileLayer.IIP=L.TileLayer.extend({options:{minZoom:0,maxZoom:18,continuousWorld:!1,noWrap:!0,contrast:1,gamma:1,unloadInvisibleTiles:L.Browser.mobile,updateWhenIdle:L.Browser.mobile},initialize:function(t,i){i=L.setOptions(this,i),i.detectRetina&&L.Browser.retina&&i.maxZoom>0&&(i.tileSize=Math.floor(i.tileSize/2),i.zoomOffset++,i.minZoom>0&&i.minZoom--,this.options.maxZoom--),this._url=t;var e=this.options.subdomains;"string"==typeof e&&(this.options.subdomains=e.split("")),this.iipTileSize={x:512,y:512},this.iipImageSize=[],this.iipImageSize[0]=this.iipTileSize,this.iipGridSize=[],this.iipGridSize[0]={x:1,y:1},this.iipMinZoom=this.iipMaxZoom=0,this.iipContrast=this.options.contrast,this.iipGamma=this.options.gamma,this.iipMinValue=[],this.iipMaxValue=[],this.iipMinValue[0]=0,this.iipMaxValue[0]=255,this.getIIPMetaData(t)},getIIPMetaData:function(i){function e(){if(4===a.readyState)if(200===a.status){var t=a.responseText,i=t.split("Max-size");i[1]||alert("Error: Unexpected response from IIP server "+o.server);var e=i[1].split(" "),n={x:parseInt(e[0].substring(1,e[0].length),10),y:parseInt(e[1],10)};i=t.split("Tile-size"),e=i[1].split(" "),o.iipTileSize={x:parseInt(e[0].substring(1,e[0].length),10),y:parseInt(e[1],10)},i=t.split("Resolution-number");for(var r=parseInt(i[1].substring(1,i[1].length),10)-1,s={x:2,y:2},l=0;r>=l&&s.x>1&&s.y>1;l++){var h={x:Math.floor(n.x/Math.pow(2,r+l)),y:Math.floor(n.y/Math.pow(2,r+l))};s={x:Math.ceil(h.x/o.iipTileSize.x),y:Math.ceil(h.y/o.iipTileSize.y)}}for(o.iipMinZoom=l-1,o.iipMinZoom>o.options.minZoom&&(o.options.minZoom=o.iipMinZoom),o.iipMaxZoom=o.iipMinZoom+r,o.options.maxZoom||(o.options.maxZoom=o.iipMaxZoom+2),o.options.maxNativeZoom||(o.options.maxNativeZoom=o.iipMaxZoom),l=0;l<=o.iipMaxZoom;l++)o.iipImageSize[l]={x:Math.floor(n.x/Math.pow(2,o.iipMaxZoom-l)),y:Math.floor(n.y/Math.pow(2,o.iipMaxZoom-l))},o.iipGridSize[l]={x:Math.ceil(o.iipImageSize[l].x/o.iipTileSize.x),y:Math.ceil(o.iipImageSize[l].y/o.iipTileSize.y)};for(l=o.iipMaxZoom;l<=o.options.maxZoom;l++)o.iipGridSize[l]=o.iipGridSize[o.iipMaxZoom];i=t.split("Min-Max-sample-values:"),i[1]||alert("Error: Unexpected response from server "+this.server);for(var p=i[1].split(" "),c=Math.floor(p.length/2),u=0,m=0;m<p.length,c>u;m++)""!==p[m]&&(o.iipMinValue[u]=parseFloat(p[m]),u++);for(var y=0,d=m;d<p.length;d++)""!==p[m]&&(o.iipMaxValue[y]=parseFloat(p[m]),y++);o.options.bounds&&(o.options.bounds=L.latLngBounds(o.options.bounds)),o.iipMetaReady=!0,o.fire("metaload")}else alert("There was a problem with the IIP metadata request.")}var a,o=this;if(t.XMLHttpRequest)a=new XMLHttpRequest;else if(t.ActiveXObject)try{a=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){try{a=new ActiveXObject("Microsoft.XMLHTTP")}catch(n){}}return a?(a.onreadystatechange=e,a.open("GET",i.replace(/\&.*$/g,"")+"&obj=IIP,1.0&obj=Max-size&obj=Tile-size"+"&obj=Resolution-number&obj=Min-Max-sample-values"),a.send(),void 0):(alert("Giving up: Cannot create an XMLHTTP instance for getting IIP metadata"),!1)},addTo:function(t){return this.iipMetaReady?t.addLayer(this):(this._premap=t,this.once("metaload",this._addToMap,this)),this},_addToMap:function(){this._premap.addLayer(this)},_getTileSizeFac:function(){var t=this._map,i=t.getZoom(),e=this.options.maxNativeZoom;return e&&i>e?Math.round(t.getZoomScale(i)/t.getZoomScale(e)):1},_getTileSize:function(){var t=this._getTileSizeFac();return{x:this.iipTileSize.x*t,y:this.iipTileSize.y*t}},_update:function(){if(this._map){var t=this._map,i=t.getPixelBounds(),e=t.getZoom(),a=this._getTileSize();if(!(e>this.options.maxZoom||e<this.options.minZoom)){var o=L.bounds(this._vecDiv(i.min.clone(),a)._floor(),this._vecDiv(i.max.clone(),a)._floor());this._addTilesFromCenterOut(o),(this.options.unloadInvisibleTiles||this.options.reuseTiles)&&this._removeOtherTiles(o)}}},_vecDiv:function(t,i){return t.x/=i.x,t.y/=i.y,t},_vecMul:function(t,i){return t.x*=i.x,t.y*=i.y,t},_tileShouldBeLoaded:function(t){if(t.x+":"+t.y in this._tiles)return!1;var i=this._getZoomForUrl();if(t.x>=this.iipGridSize[i].x||t.y>=this.iipGridSize[i].y)return!1;var e=this.options;if(!e.continuousWorld){var a=this._getWrapTileNum();if(e.noWrap&&(t.x<0||t.x>=a)||t.y<0||t.y>=a)return!1}if(e.bounds){var o=this.iipTileSize,n=this._vecMul(t.clone(),o),r=n.add(o),s=this._map.unproject(n),l=this._map.unproject(r);if(e.continuousWorld||e.noWrap||(s=s.wrap(),l=l.wrap()),!e.bounds.intersects([s,l]))return!1}return!0},_getTilePos:function(t){var i=this._map.getPixelOrigin(),e=this._getTileSize();return this._vecMul(t.clone(),e).subtract(i)},getTileUrl:function(t){return L.Util.template(this._url,L.extend({s:this._getSubdomain(t),z:t.z-this.iipMinZoom,c:this.iipContrast,g:this.iipGamma,m:this.iipMinValue,M:this.iipMaxValue,t:t.x+this.iipGridSize[t.z].x*t.y},this.options))},_createTile:function(){var t=L.DomUtil.create("img","leaflet-tile");if(this._getTileSizeFac()>1){var i=this._getTileSize();L.Browser.ie?t.style.msInterpolationMode="nearest-neighbor":t.style.imageRendering=L.Browser.chrome?"-webkit-optimize-speed":"-moz-crisp-edges",t.style.width=i.x+"px",t.style.height=i.y+"px"}return t.galleryimg="no",t.onselectstart=t.onmousemove=L.Util.falseFn,L.Browser.ielt9&&this.options.opacity!==e&&L.DomUtil.setOpacity(t,this.options.opacity),t}}),L.tileLayer.iip=function(t,i){return new L.TileLayer.IIP(t,i)},L.Control.AdjustLayers=L.Control.Layers.extend({getActiveBaseLayer:function(){return this._activeBaseLayer},getActiveOverlayLayers:function(){return this._activeOverlayLayers},onAdd:function(t){var i=L.Control.Layers.prototype.onAdd.call(this,t);return i},_findActiveBaseLayer:function(){var t=this._layers;for(var i in t)if(this._layers.hasOwnProperty(i)){var e=t[i];if(!e.overlay&&this._map.hasLayer(e.layer))return e}throw new Error("Control doesn't have any active base layer!")},_findActiveOverlayLayers:function(){var t={},i=this._layers;for(var e in i)if(this._layers.hasOwnProperty(e)){var a=i[e];a.overlay&&this._map.hasLayer(a.layer)&&(t[e]=a)}return t},_onInputClick:function(){var t,i,e,a,o=this._form.getElementsByClassName("leaflet-control-layers-selector"),n=o.length;for(this._handlingClick=!0,t=0;n>t;t++)i=o[t],e=this._layers[i.layerId],i.checked&&!this._map.hasLayer(e.layer)?(this._map.addLayer(e.layer),e.overlay?this._activeOverlayLayers[i.layerId]=e:(a=e.layer,this._activeBaseLayer=e)):!i.checked&&this._map.hasLayer(e.layer)&&(this._map.removeLayer(e.layer),e.overlay&&delete this._activeOverlayLayers[i.layerId]);a&&(this._map.setZoom(this._map.getZoom()),this._map.fire("baselayerchange",{layer:a})),this._handlingClick=!1},_addItem:function(t){var e,a=this,o=i.createElement("div"),n=this._map.hasLayer(t.layer);t.overlay?(e=i.createElement("input"),e.type="checkbox",e.className="leaflet-control-layers-selector",e.defaultChecked=n):e=this._createRadioElement("leaflet-base-layers",n),e.layerId=L.stamp(t.layer),L.DomEvent.on(e,"click",this._onInputClick,this);var r=i.createElement("span");if(r.innerHTML=" "+t.name+" ",o.appendChild(e),o.appendChild(r),!t.overlay){var s=i.createElement("input");s.className="leaflet-minValue",s.type="text",s.value=String(t.layer.iipMinValue[0]),s.layer=t.layer,o.appendChild(s),L.DomEvent.on(s,"change",function(){a._onInputChange(s,"iipMinValue[0]")},this);var l=i.createElement("input");l.className="leaflet-minValue",l.type="text",l.value=String(t.layer.iipMaxValue[0]),l.layer=t.layer,o.appendChild(l),L.DomEvent.on(l,"change",function(){a._onInputChange(l,"iipMaxValue[0]")},this)}var h=t.overlay?this._overlaysList:this._baseLayersList;return h.appendChild(o),o},_onInputChange:function(t,i){var e=i.split(/\[|\]/);e[1]?t.layer[e[0]][parseInt(e[1],10)]=t.value:t.layer[e[0]]=t.value,t.layer.redraw()}}),L.control.adjustLayers=function(t,i,e){return new L.Control.AdjustLayers(t,i,e)}}(window,document);