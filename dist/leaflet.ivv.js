/*
#	Copyright:    (C) 2013 Emmanuel Bertin - IAP/CNRS/UPMC
#                        Chiara Marmo - IDES/Paris-Sud,
#                        Ruven Pillay - C2RMF/CNRS
#
#	License:		GNU General Public License
#
#	This Leaflet plug-in is free software: you can redistribute it and/or modify
#	it under the terms of the GNU General Public License as published by
#	the Free Software Foundation, either version 3 of the License, or
# 	(at your option) any later version.
#	This plug-in is distributed in the hope that it will be useful,
#	but WITHOUT ANY WARRANTY; without even the implied warranty of
#	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#	GNU General Public License for more details.
#	You should have received a copy of the GNU General Public License
#	along with this plug-in. If not, see <http://www.gnu.org/licenses/>.
*/

if(L.Projection.WCS={_phiThetaToRADec:function(t,i){var e=L.LatLng.DEG_TO_RAD,a=L.LatLng.RAD_TO_DEG,n=t.lat*e,o=Math.cos(n),r=Math.sin(n),s=i.celpole.lat*e,l=Math.cos(s),p=Math.sin(s),h=(t.lng-i.natpole.lng)*e,c=Math.cos(h);return new L.LatLng(Math.asin(r*p+o*l*c)*a,i.celpole.lng+Math.atan2(-o*Math.sin(h),r*l-o*p*c)*a)},_raDecToPhiTheta:function(t,i){var e=L.LatLng.DEG_TO_RAD,a=L.LatLng.RAD_TO_DEG,n=(t.lng-i.celpole.lng)*e,o=Math.cos(n),r=Math.sin(n),s=t.lat*e,l=Math.cos(s),p=Math.sin(s),h=i.celpole.lat*e,c=Math.cos(h),u=Math.sin(h);return new L.LatLng(Math.asin(p*u+l*c*o)*a,i.natpole.lng+Math.atan2(-l*r,p*c-l*u*o)*a)},_pixToRed:function(t,i){var e=i.cd,a=t.subtract(i.crpix);return new L.Point(a.x*e[0][0]+a.y*e[0][1],a.x*e[1][0]+a.y*e[1][1])},_redToPix:function(t,i){var e=i.cdinv;return new L.point(t.x*e[0][0]+t.y*e[0][1],t.x*e[1][0]+t.y*e[1][1]).add(i.crpix)},_invertCD:function(t){var i=1/(t[0][0]*t[1][1]-t[0][1]*t[1][0]);return[[t[1][1]*i,-t[0][1]*i],[-t[1][0]*i,t[0][0]*i]]}},L.Projection.WCS.zenithal=L.extend({},L.Projection.WCS,{paraminit:function(t){t.cdinv=this._invertCD(t.cd),t.natfid=new L.LatLng(0,90),t.celpole=t.crval},project:function(t,i){var e=this._raDecToPhiTheta(t,i);return e.lat=i.projection.thetaToR(e.lat),this._redToPix(this._phiRToRed(e),i)},unproject:function(t,i){var e=this._redToPhiR(this._pixToRed(t,i));return e.lat=i.projection.rToTheta(e.lat),this._phiThetaToRADec(e,i)},_redToPhiR:function(t){return new L.LatLng(Math.sqrt(t.x*t.x+t.y*t.y),Math.atan2(t.x,-t.y)*L.LatLng.RAD_TO_DEG)},_phiRToRed:function(t){var i=L.LatLng.DEG_TO_RAD,e=t.lng*i;return new L.Point(t.lat*Math.sin(e),-t.lat*Math.cos(e))}}),L.Projection.WCS.TAN=L.extend({},L.Projection.WCS.zenithal,{code:"TAN",rToTheta:function(t){return Math.atan2(180,Math.PI*t)*L.LatLng.RAD_TO_DEG},thetaToR:function(t){return 180/Math.PI*Math.tan((90-t)*L.LatLng.DEG_TO_RAD)}}),L.Projection.WCS.ZEA=L.extend({},L.Projection.WCS.zenithal,{code:"ZEA",rToTheta:function(t){return 90-2*Math.asin(Math.PI*t/360)*L.LatLng.RAD_TO_DEG},thetaToR:function(t){return 360/Math.PI*Math.sin(.5*(90-t)*L.LatLng.DEG_TO_RAD)}}),L.CRS.WCS=L.extend({},L.CRS,{projparam:{projection:L.Projection.WCS.TAN,ctype:{x:"RA--TAN",y:"DEC--TAN"},naxis:new L.point(256,256,!0),nzoom:1,crpix:L.point(129,129),crval:L.latLng(0,0),cd:[[1,0],[0,1]],natpole:L.latLng(90,180),tileSize:L.point(256,256),celpole:L.latLng(0,0),natfid:L.latLng(0,90),cdinv:[[1,0],[0,1]]},initialize:function(){var t=this.projparam;this.transformation=new L.Transformation(1,-1,-1,t.naxis.y),t.projection.paraminit(t),this.code+=":"+t.projection.code,this.ready=!0},code:"WCS",projection:L.Projection.WCS,latLngToPoint:function(t,i){this.ready||this.initialize();var e=this.projparam.projection.project(t,this.projparam),a=this.scale(i);return this.transformation._transform(e,a)},pointToLatLng:function(t,i){this.ready||this.initialize();var e=this.scale(i),a=this.transformation.untransform(t,e);return this.projparam.projection.unproject(a,this.projparam)},project:function(t){return this.ready||this.initialize(),this.projparam.projection.project(t,this.projparam)},scale:function(t){return Math.pow(2,t-this.projparam.nzoom+1)},zoom1:function(t,i){return Math.ceil(Math.log(Math.max(t.x/i.x,t.y/i.y))/Math.LN2)},distance:function(t,i){var e=L.LatLng.DEG_TO_RAD,a=t.lat*e,n=i.lat*e,o=n-a,r=(i.lng-t.lng)*e,s=Math.sin(o/2),l=Math.sin(r/2),p=s*s+l*l*Math.cos(a)*Math.cos(n);return 2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p))*L.LatLng.RAD_TO_DEG}}),L.TileLayer.IIP=L.TileLayer.extend({options:{minZoom:0,maxZoom:18,continuousWorld:!1,noWrap:!0,contrast:1,gamma:1,cMap:"grey",unloadInvisibleTiles:L.Browser.mobile,updateWhenIdle:L.Browser.mobile},iip:{TileSize:{x:512,y:512},ImageSize:[],GridSize:[],BPP:8,MinZoom:0,MaxZoom:0,Contrast:1,Gamma:1,CMap:"grey",MinValue:[],MaxValue:[]},iipdefault:{Contrast:1,Gamma:1,CMap:"grey",MinValue:[],MaxValue:[]},initialize:function(t,i){i=L.setOptions(this,i),i.detectRetina&&L.Browser.retina&&i.maxZoom>0&&(i.tileSize=Math.floor(i.tileSize/2),i.zoomOffset++,i.minZoom>0&&i.minZoom--,this.options.maxZoom--),this._url=t.replace(/\&.*$/g,"");var e=this.options.subdomains;"string"==typeof e&&(this.options.subdomains=e.split("")),this.iip.ImageSize[0]=this.iip.TileSize,this.iip.GridSize[0]={x:1,y:1},this.iip.Contrast=this.options.contrast,this.iip.Gamma=this.options.gamma,this.iip.MinValue[0]=0,this.iip.MaxValue[0]=255,this.getIIPMetaData(this._url)},getIIPMetaData:function(t){this.requestURI(t+"&obj=IIP,1.0&obj=max-size&obj=tile-size"+"&obj=resolution-number&obj=bits-per-channel"+"&obj=min-max-sample-values","getting IIP metadata",this._parseMetadata,this)},requestURI:function(t,i,e){var a,n=this;if(window.XMLHttpRequest)a=new XMLHttpRequest;else if(window.ActiveXObject)try{a=new ActiveXObject("Msxml2.XMLHTTP")}catch(o){try{a=new ActiveXObject("Microsoft.XMLHTTP")}catch(o){}}return a?(a.onreadystatechange=function(){e(n,a)},a.open("GET",t),a.send(),void 0):(alert("Giving up: Cannot create an XMLHTTP instance for "+i),!1)},_parseMetadata:function(t,i){if(4===i.readyState)if(200===i.status){var e=i.responseText,a=e.split("Max-size");a[1]||alert("Error: Unexpected response from IIP server "+t._url.replace(/\?.*$/g,""));var n=a[1].split(" "),o={x:parseInt(n[0].substring(1,n[0].length),10),y:parseInt(n[1],10)};a=e.split("Tile-size"),n=a[1].split(" "),t.iip.TileSize={x:parseInt(n[0].substring(1,n[0].length),10),y:parseInt(n[1],10)},a=e.split("Resolution-number");for(var r=parseInt(a[1].substring(1,a[1].length),10)-1,s={x:2,y:2},l=0;r>=l&&s.x>1&&s.y>1;l++){var p={x:Math.floor(o.x/Math.pow(2,r+l)),y:Math.floor(o.y/Math.pow(2,r+l))};s={x:Math.ceil(p.x/t.iip.TileSize.x),y:Math.ceil(p.y/t.iip.TileSize.y)}}for(t.iip.MinZoom=l-1,t.iip.MinZoom>t.options.minZoom&&(t.options.minZoom=t.iip.MinZoom),t.iip.MaxZoom=t.iip.MinZoom+r,t.options.maxZoom||(t.options.maxZoom=t.iip.MaxZoom+2),t.options.maxNativeZoom||(t.options.maxNativeZoom=t.iip.MaxZoom),l=0;l<=t.iip.MaxZoom;l++)t.iip.ImageSize[l]={x:Math.floor(o.x/Math.pow(2,t.iip.MaxZoom-l)),y:Math.floor(o.y/Math.pow(2,t.iip.MaxZoom-l))},t.iip.GridSize[l]={x:Math.ceil(t.iip.ImageSize[l].x/t.iip.TileSize.x),y:Math.ceil(t.iip.ImageSize[l].y/t.iip.TileSize.y)};for(l=t.iip.MaxZoom;l<=t.options.maxZoom;l++)t.iip.GridSize[l]=t.iip.GridSize[t.iip.MaxZoom];a=e.split("Bits-per-channel"),t.iip.BPP=parseInt(a[1].substring(1,a[1].length),10),t.iip.Gamma=t.iip.BPP>=32?.45:1,a=e.split("Min-Max-sample-values:"),a[1]||alert("Error: Unexpected response from server "+this.server);for(var h=a[1].split(" "),c=Math.floor(h.length/2),u=0,m=0;m<h.length,c>u;m++)""!==h[m]&&(t.iipdefault.MinValue[u]=t.iip.MinValue[u]=parseFloat(h[m]),u++);for(var d=0,_=m;_<h.length;_++)""!==h[m]&&(t.iipdefault.MaxValue[d]=t.iip.MaxValue[d]=parseFloat(h[m]),d++);t.options.bounds&&(t.options.bounds=L.latLngBounds(t.options.bounds)),t.iip.MetaReady=!0,t.fire("metaload")}else alert("There was a problem with the IIP metadata request.")},addTo:function(t){return this.iip.MetaReady?t.addLayer(this):(this._premap=t,this.once("metaload",this._addToMap,this)),this},_addToMap:function(){this._premap.addLayer(this),this._premap=void 0},_getTileSizeFac:function(){var t=this._map,i=t.getZoom(),e=this.options.maxNativeZoom;return e&&i>e?Math.round(t.getZoomScale(i)/t.getZoomScale(e)):1},_getTileSize:function(){var t=this._getTileSizeFac();return{x:this.iip.TileSize.x*t,y:this.iip.TileSize.y*t}},_update:function(){if(this._map){var t=this._map,i=t.getPixelBounds(),e=t.getZoom(),a=this._getTileSize();if(!(e>this.options.maxZoom||e<this.options.minZoom)){var n=L.bounds(this._vecDiv(i.min.clone(),a)._floor(),this._vecDiv(i.max.clone(),a)._floor());this._addTilesFromCenterOut(n),(this.options.unloadInvisibleTiles||this.options.reuseTiles)&&this._removeOtherTiles(n)}}},_vecDiv:function(t,i){return t.x/=i.x,t.y/=i.y,t},_vecMul:function(t,i){return t.x*=i.x,t.y*=i.y,t},_tileShouldBeLoaded:function(t){if(t.x+":"+t.y in this._tiles)return!1;var i=this._getZoomForUrl();if(t.x>=this.iip.GridSize[i].x||t.y>=this.iip.GridSize[i].y)return!1;var e=this.options;if(!e.continuousWorld){var a=this._getWrapTileNum();if(e.noWrap&&(t.x<0||t.x>=a)||t.y<0||t.y>=a)return!1}if(e.bounds){var n=this.iip.TileSize,o=this._vecMul(t.clone(),n),r=o.add(n),s=this._map.unproject(o),l=this._map.unproject(r);if(e.continuousWorld||e.noWrap||(s=s.wrap(),l=l.wrap()),!e.bounds.intersects([s,l]))return!1}return!0},_getTilePos:function(t){var i=this._map.getPixelOrigin(),e=this._getTileSize();return this._vecMul(t.clone(),e).subtract(i)},getTileUrl:function(t){var i=this._url;return this.iip.CMap!==this.iipdefault.CMap&&(i+="&CMP="+this.iip.CMap),this.iip.Contrast!==this.iipdefault.Contrast&&(i+="&CNT="+this.iip.Contrast.toString()),this.iip.Gamma!==this.iipdefault.Gamma&&(i+="&GAM="+this.iip.Gamma.toString()),(this.iip.MinValue[0]!==this.iipdefault.MinValue[0]||this.iip.MaxValue[0]!==this.iipdefault.MaxValue[0])&&(i+="&MINMAX=1,"+this.iip.MinValue[0].toString()+","+this.iip.MaxValue[0].toString()),i+"&JTL="+(t.z-this.iip.MinZoom).toString()+","+(t.x+this.iip.GridSize[t.z].x*t.y).toString()},_createTile:function(){var t=L.DomUtil.create("img","leaflet-tile");if(this._getTileSizeFac()>1){var i=this._getTileSize();L.Browser.ie?t.style.msInterpolationMode="nearest-neighbor":t.style.imageRendering=L.Browser.chrome?"-webkit-optimize-speed":"-moz-crisp-edges",t.style.width=i.x+"px",t.style.height=i.y+"px"}return t.galleryimg="no",t.onselectstart=t.onmousemove=L.Util.falseFn,L.Browser.ielt9&&void 0!==this.options.opacity&&L.DomUtil.setOpacity(t,this.options.opacity),t}}),L.tileLayer.iip=function(t,i){return new L.TileLayer.IIP(t,i)},L.Control.IIP=L.Control.extend({options:{title:"a control related to IIPImage",collapsed:!0,position:"topleft"},initialize:function(t,i){L.setOptions(this,i),this._className="leaflet-control-iipimage",this._layers=t},onAdd:function(){var t=this._className,i=this._container=L.DomUtil.create("div",t+" leaflet-bar");if(i.setAttribute("aria-haspopup",!0),L.Browser.touch?L.DomEvent.on(i,"click",L.DomEvent.stopPropagation):(L.DomEvent.disableClickPropagation(i),L.DomEvent.on(i,"mousewheel",L.DomEvent.stopPropagation)),this._dialog=L.DomUtil.create("div",t+"-dialog",i),this.options.collapsed){L.Browser.android||L.DomEvent.on(i,"mouseover",this._expand,this).on(i,"mouseout",this._collapse,this);var e=this._link=L.DomUtil.create("a",t+"-button leaflet-bar",i);e.href="#",e.title=this.options.title,L.Browser.touch?L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",this._expand,this):L.DomEvent.on(e,"focus",this._expand,this),this._map.on("click",this._collapse,this)}else this._expand();return this._checkLayer(),this._container},_checkLayer:function(){var t=this._layer=this._findActiveBaseLayer();t?this._initDialog():this._prelayer&&this._prelayer.once("metaload",this._checkLayer,this)},_initDialog:function(){this._className,this._container,this._dialog,this._link,this._layer},_expand:function(){L.DomUtil.addClass(this._container,this._className+"-expanded")},_collapse:function(){this._container.className=this._container.className.replace(" "+this._className+"-expanded","")},getActiveBaseLayer:function(){return this._activeBaseLayer},_findActiveBaseLayer:function(){var t=this._layers;this._prelayer=void 0;for(var i in t){var e=t[i];if(!e.overlay)if(e._premap)this._prelayer=e;else if(this._map.hasLayer(e)&&e.iip)return e}return void 0},_onInputChange:function(t,i,e){var a=i.split(/\[|\]/);a[1]?t.layer.iip[a[0]][parseInt(a[1],10)]=e:t.layer.iip[a[0]]=e,t.layer.redraw()}}),L.control.iip=function(t,i){return new L.Control.IIP(t,i)},"undefined"!=typeof require)var $=require("jquery-browser");L.Control.IIP.Image=L.Control.IIP.extend({options:{title:"Image adjustment",collapsed:!0,cmap:"grey",position:"topleft"},initialize:function(t,i){L.setOptions(this,i),this._className="leaflet-control-iipimage",this._layers=t},_initDialog:function(){var t,i=this,e=this._className,a=this._dialog,n=this._layer,o=["grey","jet","cold","hot"];t=this._addDialogLine("LUT:");var r=L.DomUtil.create("span",e+"-cmaps",t);for(var s in o){var l=document.createElement("input");l.className="leaflet-cmap-"+o[s],l.type="button",l.name="button",l.cmap=o[s],l.layer=n,r.appendChild(l),o[s]===this.options.cmap&&(l.checked="checked")}$("."+e+"-cmaps").buttonset(),$("."+e+"-cmaps :button").click(function(){i._onInputChange(this,"CMap",this.cmap)}),this._separator=L.DomUtil.create("div",e+"-separator",a);var p=((n.iip.MaxValue[0]-n.iip.MinValue[0])/100).toPrecision(1);t=this._addDialogLine("Min:");var h=L.DomUtil.create("input","",t);h.id="leaflet-minvalue",h.type="text",h.value=String(n.iip.MinValue[0]),h.layer=n,$("#leaflet-minvalue").spinner({stop:function(){i._onInputChange(h,"MinValue[0]",h.value)},icons:{down:"icon-minus",up:"icon-plus"},step:p}),L.DomEvent.on(h,"change",function(){i._onInputChange(h,"MinValue[0]",h.value)},this),t=this._addDialogLine("Max:");var c=L.DomUtil.create("input","",t);c.id="leaflet-maxvalue",c.type="text",c.value=String(n.iip.MaxValue[0]),c.layer=n,$("#leaflet-maxvalue").spinner({stop:function(){i._onInputChange(c,"MaxValue[0]",c.value)},icons:{down:"icon-minus",up:"icon-plus"},step:p}),L.DomEvent.on(c,"change",function(){i._onInputChange(c,"MaxValue[0]",c.value)},this),t=this._addDialogLine("Gamma:");var u=L.DomUtil.create("input","leaflet-slider-input",t);u.type="text",u.value=String(n.iip.Gamma),u.layer=n;var m=L.DomUtil.create("span","",t);m.id="leaflet-gamma-slider",$("#leaflet-gamma-slider").slider({stop:function(t,e){i._onInputChange(u,"Gamma",e.value)},slide:function(t,i){u.value=i.value},value:String(n.iip.Gamma),step:.05,min:.05,max:2}),L.DomEvent.on(u,"change",function(){i._onInputChange(u,"Gamma",u.value),$("#leaflet-gamma-slider").slider("value",u.value)},this),t=this._addDialogLine("Contrast:");var d=L.DomUtil.create("input","leaflet-slider-input",t);d.type="text",d.value=String(n.iip.Contrast),d.layer=n;var _=L.DomUtil.create("span","",t);_.id="leaflet-contrast-slider",$("#leaflet-contrast-slider").slider({stop:function(t,e){i._onInputChange(d,"Contrast",e.value)},slide:function(t,i){d.value=i.value},value:String(n.iip.Contrast),step:.05,min:.05,max:4}),L.DomEvent.on(d,"change",function(){i._onInputChange(d,"Contrast",d.value),$("#leaflet-contrast-slider").slider("value",d.value)},this)},_addDialogLine:function(t){var i=L.DomUtil.create("div",this._className+"-element",this._dialog),e=L.DomUtil.create("span",this._className+"-label",i);return e.innerHTML=t,i}}),L.control.iip.image=function(t,i){return new L.Control.IIP.Image(t,i)},L.Draw.Line=L.Draw.Polyline.extend({_updateFinishHandler:function(){var t=this._markers.length;t>1&&this._markers[t-1].on("click",this._finishShape,this),t>2&&this._markers[t-2].off("click",this._finishShape,this),t>=2&&this._finishShape()},_getMeasurementString:function(){var t,i,e,a=this._currentLatLng,n=this._markers[this._markers.length-1].getLatLng();return t=this._measurementRunningTotal+L.CRS.WCS.distance(a,n),t>=1?e="&#176;":(t*=60,t>=1?e="&#39;":(t*=60,e="&#34;")),i=t.toFixed(2)+e}}),L.Control.IIP.Plot=L.Control.IIP.extend({options:{title:"Image adjustment",collapsed:!0,position:"topleft"},initialize:function(t,i){L.setOptions(this,i),this._className="leaflet-control-iipplot",this._layers=t},_initDialog:function(){var t=this._className,i=this._dialog,e=this._layer;this._profile=L.DomUtil.create("div",t+"-profile",i);var a=document.createElement("input");a.className="leaflet-profile",a.type="button",a.layer=e,this._profile.appendChild(a),L.DomEvent.on(a,"click",this.getProfile,this)},getProfile:function(){L.drawLocal.draw.handlers.polyline.tooltip.cont="Click to end drawing line.";var t=new L.Draw.Line(this._map),i=this;this._map.on("draw:created",function(e){var a=e.layer;i._map.addLayer(a),t.removeHooks(),console.log(a._latlngs)}),t.addHooks(),this._layer.requestURI(this._layer._url.replace(/\&.*$/g,"")+"&PFL=9:20,100-9000,2000","getting IIP layer profile",this._parseProfile,this)},_parseProfile:function(t,i){4===i.readyState&&200===i.status&&i.responseText}}),L.control.iip.plot=function(t,i){return new L.Control.IIP.Plot(t,i)};