/*
#	Copyright:    (C) 2013 Emmanuel Bertin - IAP/CNRS/UPMC
#                        Chiara Marmo - IDES/Paris-Sud,
#                        Ruven Pillay - C2RMF/CNRS
#
#	License:		GNU General Public License
#
#	This Leaflet plug-in is free software: you can redistribute it and/or modify
#	it under the terms of the GNU General Public License as published by
#	the Free Software Foundation, either version 3 of the License, or
# 	(at your option) any later version.
#	This plug-in is distributed in the hope that it will be useful,
#	but WITHOUT ANY WARRANTY; without even the implied warranty of
#	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#	GNU General Public License for more details.
#	You should have received a copy of the GNU General Public License
#	along with this plug-in. If not, see <http://www.gnu.org/licenses/>.
*/

if(L.IIPUtils={REG_PDEC:"(\\d+\\.\\d*)",REG_FLOAT:"([-+]?[0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)",requestURI:function(t,i,e,o){var a;if(window.XMLHttpRequest)a=new XMLHttpRequest;else if(window.ActiveXObject)try{a=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){try{a=new ActiveXObject("Microsoft.XMLHTTP")}catch(n){}}return a?(a.open("GET",t),a.onreadystatechange=function(){e(o,a)},a.send(),void 0):(alert("Giving up: Cannot create an XMLHTTP instance for "+i),!1)},distance:function(t,i){var e=L.LatLng.DEG_TO_RAD,o=t.lat*e,a=i.lat*e,n=a-o,s=(i.lng-t.lng)*e,r=Math.sin(n/2),l=Math.sin(s/2),p=r*r+l*l*Math.cos(o)*Math.cos(a);return 2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p))*L.LatLng.RAD_TO_DEG}},L.Projection.WCS={_phiThetaToRADec:function(t,i){var e=L.LatLng.DEG_TO_RAD,o=L.LatLng.RAD_TO_DEG,a=t.lat*e,n=Math.cos(a),s=Math.sin(a),r=i.celpole.lat*e,l=Math.cos(r),p=Math.sin(r),c=(t.lng-i.natpole.lng)*e,h=Math.cos(c),d=s*p+n*l*h;return d>1?d=1:-1>d&&(d=-1),new L.LatLng(Math.asin(d)*o,i.celpole.lng+Math.atan2(-n*Math.sin(c),s*l-n*p*h)*o)},_raDecToPhiTheta:function(t,i){var e=L.LatLng.DEG_TO_RAD,o=L.LatLng.RAD_TO_DEG,a=(t.lng-i.celpole.lng)*e,n=Math.cos(a),s=Math.sin(a),r=t.lat*e,l=Math.cos(r),p=Math.sin(r),c=i.celpole.lat*e,h=Math.cos(c),d=Math.sin(c),u=p*d+l*h*n;return u>1?u=1:-1>u&&(u=-1),new L.LatLng(Math.asin(u)*o,i.natpole.lng+Math.atan2(-l*s,p*h-l*d*n)*o)},_pixToRed:function(t,i){var e=i.cd,o=t.subtract(i.crpix);return new L.Point(o.x*e[0][0]+o.y*e[0][1],o.x*e[1][0]+o.y*e[1][1])},_redToPix:function(t,i){var e=i.cdinv;return new L.point(t.x*e[0][0]+t.y*e[0][1],t.x*e[1][0]+t.y*e[1][1]).add(i.crpix)},_invertCD:function(t){var i=1/(t[0][0]*t[1][1]-t[0][1]*t[1][0]);return[[t[1][1]*i,-t[0][1]*i],[-t[1][0]*i,t[0][0]*i]]}},L.Projection.WCS.zenithal=L.extend({},L.Projection.WCS,{paraminit:function(t){t.cdinv=this._invertCD(t.cd),t.natfid=new L.LatLng(0,90),t.celpole=t.crval},project:function(t,i){var e=this._raDecToPhiTheta(t,i);return e.lat=i.projection.thetaToR(e.lat),this._redToPix(this._phiRToRed(e),i)},unproject:function(t,i){var e=this._redToPhiR(this._pixToRed(t,i));return e.lat=i.projection.rToTheta(e.lat),this._phiThetaToRADec(e,i)},_redToPhiR:function(t){return new L.LatLng(Math.sqrt(t.x*t.x+t.y*t.y),Math.atan2(t.x,-t.y)*L.LatLng.RAD_TO_DEG)},_phiRToRed:function(t){var i=L.LatLng.DEG_TO_RAD,e=t.lng*i;return new L.Point(t.lat*Math.sin(e),-t.lat*Math.cos(e))}}),L.Projection.WCS.TAN=L.extend({},L.Projection.WCS.zenithal,{code:"TAN",rToTheta:function(t){return Math.atan2(180,Math.PI*t)*L.LatLng.RAD_TO_DEG},thetaToR:function(t){return 180/Math.PI*Math.tan((90-t)*L.LatLng.DEG_TO_RAD)}}),L.Projection.WCS.ZEA=L.extend({},L.Projection.WCS.zenithal,{code:"ZEA",rToTheta:function(t){var i=Math.PI*t/360;return Math.abs(i)<1?90-2*Math.asin(i)*L.LatLng.RAD_TO_DEG:90},thetaToR:function(t){return 360/Math.PI*Math.sin(.5*(90-t)*L.LatLng.DEG_TO_RAD)}}),L.WCS=L.Class.extend({includes:L.Mixin.Events,options:{projection:L.Projection.WCS.TAN,ctype:{x:"RA--TAN",y:"DEC--TAN"},naxis:L.point(256,256,!0),nzoom:9,crpix:L.point(129,129),crval:L.latLng(0,0),cd:[[1,0],[0,1]],natpole:L.latLng(90,180),tileSize:L.point(256,256),celpole:L.latLng(0,0),natfid:L.latLng(0,90),cdinv:[[1,0],[0,1]]},initialize:function(t,i){switch(i=L.setOptions(this,i),t&&this._readWCS(t),i.ctype.x.substr(5,3)){case"ZEA":i.projection=L.Projection.WCS.ZEA;break;case"TAN":i.projection=L.Projection.WCS.TAN;break;default:i.projection=L.Projection.WCS.TAN}this.transformation=new L.Transformation(1,-.5,-1,i.naxis.y+.5),i.projection.paraminit(i),this.code+=":"+i.projection.code},code:"WCS",projection:L.Projection.WCS,latLngToPoint:function(t,i){var e=this.options.projection.project(t,this.options),o=this.scale(i);return this.transformation._transform(e,o)},pointToLatLng:function(t,i){var e=this.scale(i),o=this.transformation.untransform(t,e);return this.options.projection.unproject(o,this.options)},project:function(t){return this.options.projection.project(t,this.options)},scale:function(t){return Math.pow(2,t-this.options.nzoom+1)},getSize:function(t){var i=this.scale(t);return L.point(i,i)},zoom1:function(t,i){return Math.ceil(Math.log(Math.max(t.x/i.x,t.y/i.y))/Math.LN2)},_readWCS:function(t){var i,e=this.options,o=this._readFITSKey;(i=o("CTYPE1",t))&&(e.ctype.x=i),(i=o("CTYPE2",t))&&(e.ctype.y=i),(i=o("NAXIS1",t))&&(e.naxis.x=parseInt(i,10)),(i=o("NAXIS2",t))&&(e.naxis.y=parseInt(i,10)),(i=o("CRPIX1",t))&&(e.crpix.x=parseFloat(i,10)),(i=o("CRPIX2",t))&&(e.crpix.y=parseFloat(i,10)),(i=o("CRVAL1",t))&&(e.crval.lng=parseFloat(i,10)),(i=o("CRVAL2",t))&&(e.crval.lat=parseFloat(i,10)),(i=o("CD1_1",t))&&(e.cd[0][0]=parseFloat(i,10)),(i=o("CD1_2",t))&&(e.cd[0][1]=parseFloat(i,10)),(i=o("CD2_1",t))&&(e.cd[1][0]=parseFloat(i,10)),(i=o("CD2_2",t))&&(e.cd[1][1]=parseFloat(i,10))},_readFITSKey:function(t,i){var e=t.trim().toUpperCase().substr(0,8),o=8-e.length,a=new RegExp(e+"\\ {"+o.toString()+"}=\\ *(?:'(\\S*)\\ *'|([-+]?[0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?))"),n=a.exec(i);return n?n[1]?n[1]:n[2]:null}}),L.wcs=function(t){return new L.WCS(t)},L.Control.WCS=L.Control.extend({options:{position:"bottomleft",units:"HMS"},onAdd:function(t){var i=this._wcsinput=L.DomUtil.create("input","leaflet-control-wcs");return L.DomEvent.disableClickPropagation(i),i.type="text","webkitSpeechRecognition"in window&&i.setAttribute("x-webkit-speech","x-webkit-speech"),t.on("drag",this._onDrag,this),L.DomEvent.on(i,"change",this._onInputChange,this),this._wcsinput},onRemove:function(t){t.off("drag",this._onDrag)},_onDrag:function(){var t=this._map.getCenter();this._wcsinput.value="HMS"===this.options.units?this._latLngToHMSDMS(t):t.lng.toFixed(5)+" , "+t.lat.toFixed(5)},_latLngToHMSDMS:function(t){var i=(t.lng+360)/360;i=24*(i-Math.floor(i));var e=Math.floor(i),o=60*(i-e),a=Math.floor(o),n=60*(o-a);n>=60&&(a++,n=0),60===a&&(e++,a=0);var s=e.toString()+":"+(10>a?"0":"")+a.toString()+":"+(10>n?"0":"")+n.toFixed(3),r=Math.abs(t.lat),l=t.lat<0?"-":"+",p=Math.floor(r);return o=60*(r-p),a=Math.floor(o),n=60*(o-a),n>=60&&(a++,n=0),60===a&&(e++,a=0),s+" "+l+(10>p?"0":"")+p.toString()+":"+(10>a?"0":"")+a.toString()+":"+(10>n?"0":"")+n.toFixed(2)},_onInputChange:function(){var t=/^(\d+\.?\d*)\s*,?\s*\+?(-?\d+\.?\d*)/g,i=this._wcsinput.value,e=t.exec(i);e&&e.length>=3?this._map.panTo({lat:Number(e[2]),lng:Number(e[1])}):L.IIPUtils.requestURI("/cgi-bin/nph-sesame/-oI?"+i,"getting coordinates for "+i,this._getCoordinates,this,!0)},_getCoordinates:function(t,i){if(4===i.readyState)if(200===i.status){var e=/J\s(\d+\.?\d*)\s*,?\s*\+?(-?\d+\.?\d*)/g,o=i.responseText,a=e.exec(o);a&&a.length>=3?(t._map.panTo({lat:Number(a[2]),lng:Number(a[1])}),t._wcsinput.value=a[0]):alert(o+": Unknown location")}else alert("There was a problem with the request to the Sesame service at CDS")}}),L.Map.mergeOptions({positionControl:!1}),L.Map.addInitHook(function(){this.options.positionControl&&(this.positionControl=new L.Control.MousePosition,this.addControl(this.positionControl))}),L.control.wcs=function(t){return new L.Control.WCS(t)},L.Control.Scale.WCS=L.Control.Scale.extend({options:{position:"bottomleft",maxWidth:128,metric:!1,imperial:!1,degrees:!0,pixels:!0,planetRadius:6378137,updateWhenIdle:!1},_addScales:function(t,i,e){t.metric&&(this._mScale=L.DomUtil.create("div",i+"-line",e)),t.imperial&&(this._iScale=L.DomUtil.create("div",i+"-line",e)),t.degrees&&(this._dScale=L.DomUtil.create("div",i+"-line",e)),t.pixels&&(this._pScale=L.DomUtil.create("div",i+"-line",e)),this.angular=t.metric||t.imperial||t.degrees},_update:function(){var t=this.options,i=this._map;if(t.pixels){var e=i.options.crs;if(e.options&&e.options.nzoom){var o=Math.pow(2,e.options.nzoom-1-i.getZoom());this._updatePixels(o*t.maxWidth)}}if(this.angular){var a=i.getCenter(),n=Math.cos(a.lat*Math.PI/180),s=Math.sqrt(this._jacobian(a))*n,r=s*t.maxWidth;t.metric&&this._updateMetric(r*Math.PI/180*t.planetRadius),t.imperial&&this._updateImperial(r*Math.PI/180*t.planetRadius),t.degrees&&this._updateDegrees(r)}},_jacobian:function(t){var i=this._map,e=i.project(t),o=i.unproject(e.add([10,0])),a=i.unproject(e.add([0,10]));return.01*Math.abs((o.lng-t.lng)*(a.lat-t.lat)-(a.lng-t.lng)*(o.lat-t.lat))},_updatePixels:function(t){var i=this._pScale;if(t>1e6){var e=1e-6*t,o=this._getRoundNum(e);i.style.width=this._getScaleWidth(o/e)+"px",i.innerHTML=o+" Mpx"}else if(t>1e3){var a=.001*t,n=this._getRoundNum(a);i.style.width=this._getScaleWidth(n/a)+"px",i.innerHTML=n+" kpx"}else{var s=this._getRoundNum(t);i.style.width=this._getScaleWidth(s/t)+"px",i.innerHTML=s+" px"}},_updateDegrees:function(t){var i=3600*t,e=this._dScale;if(1>i){var o=1e3*i,a=this._getRoundNum(o);e.style.width=this._getScaleWidth(a/o)+"px",e.innerHTML=a+" mas"}else if(60>i){var n=this._getRoundNum(i);e.style.width=this._getScaleWidth(n/i)+"px",e.innerHTML=n+" &#34;"}else if(3600>i){var s=60*t,r=this._getRoundNum(s);e.style.width=this._getScaleWidth(r/s)+"px",e.innerHTML=r+" &#39;"}else{var l=this._getRoundNum(t);e.style.width=this._getScaleWidth(l/t)+"px",e.innerHTML=l+" &#176;"}}}),L.control.scale.wcs=function(t){return new L.Control.Scale.WCS(t)},L.TileLayer.IIP=L.TileLayer.extend({options:{minZoom:0,maxZoom:18,continuousWorld:!1,noWrap:!0,contrast:1,gamma:1,cMap:"grey",invertCMap:!1,quality:90,unloadInvisibleTiles:L.Browser.mobile,updateWhenIdle:L.Browser.mobile},iipdefault:{contrast:1,gamma:1,cMap:"grey",invertCMap:!1,minValue:[],maxValue:[],quality:90},initialize:function(t,i){i=L.setOptions(this,i),i.detectRetina&&L.Browser.retina&&i.maxZoom>0&&(i.tileSize=Math.floor(i.tileSize/2),i.zoomOffset++,i.minZoom>0&&i.minZoom--,this.options.maxZoom--),i.bounds&&(i.bounds=L.latLngBounds(i.bounds)),this._url=t.replace(/\&.*$/g,"");var e=this.options.subdomains;"string"==typeof e&&(this.options.subdomains=e.split("")),this.iipTileSize={x:256,y:256},this.iipImageSize=[],this.iipImageSize[0]=this.iipTileSize,this.iipGridSize=[],this.iipGridSize[0]={x:1,y:1},this.iipBPP=8,this.iipMinZoom=this.options.minZoom,this.iipMaxZoom=this.options.maxZoom,this.iipContrast=this.options.contrast,this.iipGamma=this.options.gamma,this.iipCMap=this.options.cMap,this.iipInvertCMap=this.options.invertCMap,this.iipMinValue=[],this.iipMinValue[0]=0,this.iipMaxValue=[],this.iipMaxValue[0]=255,this.iipQuality=this.options.quality,this.getIIPMetaData(this._url)},getIIPMetaData:function(t){L.IIPUtils.requestURI(t+"&obj=IIP,1.0&obj=max-size&obj=tile-size&obj=resolution-number&obj=bits-per-channel&obj=min-max-sample-values&obj=subject","getting IIP metadata",this._parseMetadata,this)},_parseMetadata:function(t,i){if(4===i.readyState)if(200===i.status){var e=i.responseText,o=t._readIIPKey(e,"IIP",L.IIPUtils.REG_PDEC);o||alert("Error: Unexpected response from IIP server "+t._url.replace(/\?.*$/g,"")),o=t._readIIPKey(e,"Max-size","(\\d+)\\s+(\\d+)");var a={x:parseInt(o[1],10),y:parseInt(o[2],10)};o=t._readIIPKey(e,"Tile-size","(\\d+)\\s+(\\d+)"),t.iipTileSize={x:parseInt(o[1],10),y:parseInt(o[2],10)},o=t._readIIPKey(e,"Resolution-number","(\\d+)");for(var n=parseInt(o[1],10)-1,s={x:2,y:2},r=0;n>=r&&s.x>1&&s.y>1;r++){var l={x:Math.floor(a.x/Math.pow(2,n+r)),y:Math.floor(a.y/Math.pow(2,n+r))};s={x:Math.ceil(l.x/t.iipTileSize.x),y:Math.ceil(l.y/t.iipTileSize.y)}}for(t.iipMinZoom=r-1,t.iipMinZoom>t.options.minZoom&&(t.options.minZoom=t.iipMinZoom),t.iipMaxZoom=t.iipMinZoom+n,t.options.maxZoom||(t.options.maxZoom=t.iipMaxZoom+2),t.options.maxNativeZoom||(t.options.maxNativeZoom=t.iipMaxZoom),r=0;r<=t.iipMaxZoom;r++)t.iipImageSize[r]={x:Math.floor(a.x/Math.pow(2,t.iipMaxZoom-r)),y:Math.floor(a.y/Math.pow(2,t.iipMaxZoom-r))},t.iipGridSize[r]={x:Math.ceil(t.iipImageSize[r].x/t.iipTileSize.x),y:Math.ceil(t.iipImageSize[r].y/t.iipTileSize.y)};for(r=t.iipMaxZoom;r<=t.options.maxZoom;r++)t.iipGridSize[r]=t.iipGridSize[t.iipMaxZoom];o=t._readIIPKey(e,"Bits-per-channel","(\\d+)"),t.iipBPP=parseInt(o[1],10),t.iipGamma=t.iipBPP>=32?2.2:1,o=t._readIIPKey(e,"Min-Max-sample-values","\\s*(.*)");for(var p=o[1].split(" "),c=p.length/2,h=0,d=0;c>d;d++)t.iipdefault.minValue[d]=t.iipMinValue[d]=parseFloat(p[h++]);for(d=0;c>d;d++)t.iipdefault.maxValue[d]=t.iipMaxValue[d]=parseFloat(p[h++]);t.options.bounds&&(t.options.bounds=L.latLngBounds(t.options.bounds)),t.wcs=new L.WCS(e,{nzoom:n+1,tileSize:t.iipTileSize}),t.iipMetaReady=!0,t.fire("metaload")}else alert("There was a problem with the IIP metadata request.")},_readIIPKey:function(t,i,e){var o=new RegExp(i+":"+e);return o.exec(t)},addTo:function(t){return this.iipMetaReady?this._addToMap(t):this.once("metaload",function(){this._addToMap(t)},this),this},_addToMap:function(t){t.addLayer(this),t.options.crs=this.wcs,t.invalidateSize(),t.setView(this.wcs.options.crval,1)},_getTileSizeFac:function(){var t=this._map,i=t.getZoom(),e=this.options.maxNativeZoom;return e&&i>e?Math.round(t.getZoomScale(i)/t.getZoomScale(e)):1},_getTileSize:function(){var t=this._getTileSizeFac();return{x:this.iipTileSize.x*t,y:this.iipTileSize.y*t}},_update:function(){if(this._map){var t=this._map,i=t.getPixelBounds(),e=t.getZoom(),o=this._getTileSize();if(!(e>this.options.maxZoom||e<this.options.minZoom)){var a=L.bounds(this._vecDiv(i.min.clone(),o)._floor(),this._vecDiv(i.max.clone(),o)._floor());this._addTilesFromCenterOut(a),(this.options.unloadInvisibleTiles||this.options.reuseTiles)&&this._removeOtherTiles(a)}}},_vecDiv:function(t,i){return t.x/=i.x,t.y/=i.y,t},_vecMul:function(t,i){return t.x*=i.x,t.y*=i.y,t},_tileShouldBeLoaded:function(t){if(t.x+":"+t.y in this._tiles)return!1;var i=this._getZoomForUrl();if(t.x>=this.iipGridSize[i].x||t.y>=this.iipGridSize[i].y)return!1;var e=this.options;if(!e.continuousWorld){var o=this._getWrapTileNum();if(e.noWrap&&(t.x<0||t.x>=o)||t.y<0||t.y>=o)return!1}if(e.bounds){var a=this.iipTileSize,n=this._vecMul(t.clone(),a),s=n.add(a),r=this._map.unproject(n),l=this._map.unproject(s);if(e.continuousWorld||e.noWrap||(r=r.wrap(),l=l.wrap()),!e.bounds.intersects([r,l]))return!1}return!0},_getTilePos:function(t){var i=this._map.getPixelOrigin(),e=this._getTileSize();return this._vecMul(t.clone(),e).subtract(i)},getTileUrl:function(t){var i=this._url;return this.iipCMap!==this.iipdefault.cMap&&(i+="&CMP="+this.iipCMap),this.iipInvertCMap!==this.iipdefault.invertCMap&&(i+="&INV"),this.iipContrast!==this.iipdefault.contrast&&(i+="&CNT="+this.iipContrast.toString()),this.iipGamma!==this.iipdefault.gamma&&(i+="&GAM="+(1/this.iipGamma).toFixed(4)),(this.iipMinValue[0]!==this.iipdefault.minValue[0]||this.iipMaxValue[0]!==this.iipdefault.maxValue[0])&&(i+="&MINMAX=1,"+this.iipMinValue[0].toString()+","+this.iipMaxValue[0].toString()),this.iipQuality!==this.iipdefault.quality&&(i+="&QLT="+this.iipQuality.toString()),i+"&JTL="+(t.z-this.iipMinZoom).toString()+","+(t.x+this.iipGridSize[t.z].x*t.y).toString()},_createTile:function(){var t=L.DomUtil.create("img","leaflet-tile");if(this._getTileSizeFac()>1){var i=this._getTileSize();L.Browser.ie?t.style.msInterpolationMode="nearest-neighbor":t.style.imageRendering=L.Browser.chrome?"-webkit-optimize-speed":"-moz-crisp-edges",t.style.width=i.x+"px",t.style.height=i.y+"px"}return t.galleryimg="no",t.onselectstart=t.onmousemove=L.Util.falseFn,L.Browser.ielt9&&void 0!==this.options.opacity&&L.DomUtil.setOpacity(t,this.options.opacity),L.Browser.mobileWebkit3d&&(t.style.WebkitBackfaceVisibility="hidden"),t}}),L.tileLayer.iip=function(t,i){return new L.TileLayer.IIP(t,i)},L.Catalog={nmax:5e3,_csvToGeoJSON:function(t){var i=new RegExp("#|--|^$"),e=t.split("\n"),o={type:"FeatureCollection",features:[]};for(var a in e){var n=e[a];if(i.test(n)===!1){var s={type:"Feature",id:"",properties:{mags:[]},geometry:{type:"Point",coordinates:[0,0]}},r=s.geometry,l=s.properties,p=n.split(";");s.id=p[0],r.coordinates[0]=parseFloat(p[1]),r.coordinates[1]=parseFloat(p[2]);var c=p.slice(3);for(var h in c)l.mags.push(parseFloat(c[h]));o.features.push(s)}}return o},_popup:function(t){var i="<div>";i+=this.objuri?'ID: <a href="'+L.Util.template(this.objuri,L.extend({ra:t.geometry.coordinates[0].toFixed(6),dec:t.geometry.coordinates[1].toFixed(6)}))+'" target="_blank">'+t.id+"</a></div>":"ID: "+t.id+"</div>";for(var e in this.properties)i+="<div>"+this.properties[e]+": "+t.properties.mags[e].toString()+"</div>";return i}},L.Catalog.TwoMASS=L.extend({},L.Catalog,{name:"2MASS point sources",attribution:"2MASS All-Sky Catalog of Point Sources (Cutri et al., 2003)",color:"yellow",maglim:17,service:"CDS",uri:"/viz-bin/asu-tsv?&-mime=csv&-source=II/246&-out=2MASS,RAJ2000,DEJ2000,Jmag,Hmag,Kmag&-out.meta=&-c={ra},{dec},eq=J2000&-c.bd={dra},{ddec}&-sort=_Kmagr&-out.max={nmax}",toGeoJSON:L.Catalog._csvToGeoJSON,properties:["Jmag","Hmag","Kmag"],objuri:"http://vizier.u-strasbg.fr/viz-bin/VizieR-5?-source=II/246&-c={ra},{dec},eq=J2000&-c.rs=0.01"}),L.Catalog.SDSS=L.extend({},L.Catalog,{name:"SDSS release 9",attribution:"SDSS Photometric Catalog, Release 9 (Adelman-McCarthy et al., 2012)",color:"yellow",maglim:25,service:"CDS",uri:"/viz-bin/asu-tsv?&-mime=csv&-source=V/139&-out=SDSS9,RAJ2000,DEJ2000,umag,gmag,rmag,imag,zmag&-out.meta=&-c={ra},{dec}&-c.bd={dra},{ddec}&-sort=imag&-out.max={nmax}",toGeoJSON:L.Catalog._csvToGeoJSON,properties:["umag","gmag","rmag","imag","zmag"],objuri:"http://vizier.u-strasbg.fr/viz-bin/VizieR-5?-source=V/139/sdss9&-c={ra},{dec},eq=J2000&-c.rs=0.01"}),L.Catalog.PPMXL=L.extend({},L.Catalog,{name:"PPMXL",attribution:"PPM-Extended, positions and proper motions by Roeser et al. 2008",color:"yellow",maglim:20,service:"CDS",uri:"/viz-bin/asu-tsv?&-mime=csv&-source=V/139&-out=SDSS9,RAJ2000,DEJ2000,Bmag,Vmag,Rmag,Jmag,HMag,KMag&-out.meta=&-c={ra},{dec}&-c.bd={dra},{ddec}&-sort=_r&-out.max={nmax}",toGeoJSON:L.Catalog._csvToGeoJSON,properties:["Jmag","Hmag","Kmag","b1mag","b2mag","r1mag","r2mag","imag"],objuri:"http://vizier.u-strasbg.fr/viz-bin/VizieR-5?-source=I/317&-c={ra},{dec},eq=J2000&-c.rs=0.01"}),L.Control.IIP=L.Control.extend({options:{title:"a control related to IIPImage",collapsed:!0,position:"topleft"},initialize:function(t,i){L.setOptions(this,i),this._className="leaflet-control-iip",this._id="leaflet-iipimage",this._layers=t},onAdd:function(){var t=this._className,i=this._id,e=this._container=L.DomUtil.create("div",t+" leaflet-bar");if(e.setAttribute("aria-haspopup",!0),L.DomEvent.disableClickPropagation(e).disableScrollPropagation(e),this._dialog=L.DomUtil.create("div",t+"-dialog",e),this.options.collapsed){L.Browser.android||L.DomEvent.on(e,"mouseover",this._expand,this).on(e,"mouseout",this._collapse,this);var o=this._toggle=L.DomUtil.create("a",t+"-toggle leaflet-bar",e);o.href="#",o.id=i+"-toggle",o.title=this.options.title,L.Browser.touch?L.DomEvent.on(o,"click",L.DomEvent.stop).on(o,"click",this._expand,this):L.DomEvent.on(o,"focus",this._expand,this),this._map.on("click",this._collapse,this)}else this._expand();return this._checkIIP(),this._container},_checkIIP:function(){var t=this._layer=this._findActiveBaseLayer();t?this._initDialog():this._prelayer&&this._prelayer.once("metaload",this._checkIIP,this)},_initDialog:function(){this._className,this._container,this._dialog,this._toggle,this._layer},_addDialogLine:function(t){var i=L.DomUtil.create("div",this._className+"-element",this._dialog),e=L.DomUtil.create("span",this._className+"-label",i);return e.innerHTML=t,i},_expand:function(){L.DomUtil.addClass(this._container,this._className+"-expanded")},_collapse:function(){this._container.className=this._container.className.replace(" "+this._className+"-expanded","")},getActiveBaseLayer:function(){return this._activeBaseLayer},_findActiveBaseLayer:function(){var t=this._layers;this._prelayer=void 0;for(var i in t){var e=t[i];if(!e.overlay)if(e._map){if(this._map.hasLayer(e)&&e.iipdefault)return e}else this._prelayer=e}return void 0},_onInputChange:function(t,i,e){var o=i.split(/\[|\]/);o[1]?t[o[0]][parseInt(o[1],10)]=e:t[o[0]]=e,t.redraw()}}),L.control.iip=function(t,i){return new L.Control.IIP(t,i)},"undefined"!=typeof require)var $=require("jquery-browser");if(L.Control.IIP.Image=L.Control.IIP.extend({options:{title:"Image adjustment",collapsed:!0,cmap:"grey",position:"topleft"},initialize:function(t,i){L.setOptions(this,i),this._className="leaflet-control-iip",this._id="leaflet-iipimage",this._layers=t},_initDialog:function(){var t,i=this,e=this._className,o=(this._dialog,this._layer),a=["grey","jet","cold","hot"];t=this._addDialogLine("LUT:");var n=L.DomUtil.create("input","leaflet-cmap-inv",t);n.id="leaflet-invertcmap",n.type="button";var s=L.DomUtil.create("span",e+"-cmaps",t),r=[];for(var l in a)r[l]=document.createElement("input"),r[l].className="leaflet-cmap-"+a[l],r[l].type="button",r[l].name="button",r[l].cmap=a[l],s.appendChild(r[l]),a[l]===this.options.cmap&&(r[l].checked="checked");$("."+e+"-cmaps").buttonset(),$("."+e+"-cmaps :button").click(function(){i._onInputChange(o,"iipCMap",this.cmap)}),$("#leaflet-invertcmap").button(),L.DomEvent.on(n,"click",function(){i._onInputChange(o,"iipInvertCMap",!o.iipInvertCMap);var t=o.iipInvertCMap?"scaleY(-1.0)":"none";for(var e in a)L.Browser.ie?r[e].style.msTransform=t:L.Browser.webkit?r[e].style.webkitTransform=t:r[e].style.transform=t},this);var p=((o.iipMaxValue[0]-o.iipMinValue[0])/100).toPrecision(1);t=this._addDialogLine("Min:");var c=L.DomUtil.create("input","",t);c.id="leaflet-minvalue",c.type="text",c.value=String(o.iipMinValue[0]),$("#"+c.id).spinner({stop:function(){i._onInputChange(o,"iipMinValue[0]",c.value)},icons:{down:"icon-minus",up:"icon-plus"},step:p}),L.DomEvent.on(c,"change",function(){i._onInputChange(o,"iipMinValue[0]",c.value)},this),t=this._addDialogLine("Max:");var h=L.DomUtil.create("input","",t);h.id="leaflet-maxvalue",h.type="text",h.value=String(o.iipMaxValue[0]),$("#"+h.id).spinner({stop:function(){i._onInputChange(o,"iipMaxValue[0]",h.value)},icons:{down:"icon-minus",up:"icon-plus"},step:p}),L.DomEvent.on(h,"change",function(){i._onInputChange(o,"iipMaxValue[0]",h.value)},this),t=this._addDialogLine("Gamma:");var d=L.DomUtil.create("input","",t);d.id="leaflet-gammavalue",d.type="text",d.value=String(o.iipGamma),$("#"+d.id).spinner({stop:function(){i._onInputChange(o,"iipGamma",d.value)},icons:{down:"icon-minus",up:"icon-plus"},step:.05,min:.5,max:5}),L.DomEvent.on(d,"change",function(){i._onInputChange(o,"iipGamma",d.value)},this),t=this._addDialogLine("Contrast:");var u=L.DomUtil.create("input","",t);u.id="leaflet-contrastvalue",u.type="text",u.value=String(o.iipContrast),$("#"+u.id).spinner({stop:function(){i._onInputChange(o,"iipContrast",u.value)},icons:{down:"icon-minus",up:"icon-plus"},step:.05,min:0,max:10}),L.DomEvent.on(u,"change",function(){i._onInputChange(o,"iipContrast",u.value)},this),t=this._addDialogLine("JPEG quality:");var m=L.DomUtil.create("input","",t);m.id="leaflet-qualvalue",m.type="text",m.value=String(o.iipQuality),$("#"+m.id).spinner({stop:function(){i._onInputChange(o,"iipQuality",m.value)},icons:{down:"icon-minus",up:"icon-plus"},step:1,min:0,max:100}),L.DomEvent.on(m,"change",function(){i._onInputChange(o,"iipQuality",m.value)},this)}}),L.control.iip.image=function(t,i){return new L.Control.IIP.Image(t,i)},"undefined"!=typeof require)var $=require("jquery-browser"),d3=require("d3");if(L.Control.IIP.Overlay=L.Control.IIP.extend({options:{title:"overlay menu",collapsed:!0,position:"topleft"},initialize:function(t,i){L.setOptions(this,i),this._className="leaflet-control-iip",this._id="leaflet-iipoverlay",this._layers=t},_initDialog:function(){var t,i=this._className,e=(this._dialog,[L.Catalog.TwoMASS,L.Catalog.SDSS,L.Catalog.PPMXL]);t=this._addDialogLine("CDS Catalog:");var o=L.DomUtil.create("input",i+"-catalogs",t);o.id="leaflet-catalog-colorpicker",o.type="text",o.value="yellow",$(document).ready(function(){$("#"+o.id).spectrum({showInput:!0,clickoutFiresChange:!0,move:function(t){o.value=t.toHexString()}})});var a=L.DomUtil.create("select",i+"-catalogs",t),n=document.createElement("option");n.value=null,n.text="Choose catalog:",n.disabled=!0,n.selected=!0,a.add(n,null);for(var s in e)n=document.createElement("option"),n.value=e[s],n.text=e[s].name,a.add(n,null);!L.Browser.android&&this.options.collapsed&&(L.DomEvent.on(a,"mousedown",function(){L.DomEvent.off(this._container,"mouseout",this._collapse,this),this.collapsedOff=!0},this),L.DomEvent.on(this._container,"mouseover",function(){this.collapsedOff&&(L.DomEvent.on(this._container,"mouseout",this._collapse,this),this.collapsedOff=!1)},this));var r=L.DomUtil.create("input",i+"-catalogs",t);r.type="button",r.value="Go",L.DomEvent.on(r,"click",function(){var t=a.selectedIndex-1;if(t>=0){var i=e[t];i.color=o.value,a.selectedIndex=0,this._getCatalog(i)}},this),t=this._addDialogLine("Profile:");var l=L.DomUtil.create("input",i+"-profile",t);l.id="leaflet-profile-colorpicker",l.type="text",l.value="magenta",$(document).ready(function(){$("#"+l.id).spectrum({showInput:!0,clickoutFiresChange:!0,move:function(t){l.value=t.toHexString()}})});var p=L.DomUtil.create("input",i+"-profile",t);p.type="button",p.value="Go",L.DomEvent.on(p,"click",this.getProfile,this)},_checkIIP:function(){var t=this._layer=this._findActiveBaseLayer();t?(this._layerControl=this._map._layerControl,this._initDialog()):this._prelayer&&this._prelayer.once("metaload",this._checkIIP,this)},_getCatalog:function(t){var i=this,e=this._map.getCenter(),o=this._map.getBounds(),a=Math.abs(Math.cos(e.lat))*L.LatLng.DEG_TO_RAD,n=Math.abs(o.getWest()-o.getEast()),s=Math.abs(o.getNorth()-o.getSouth());1e-4>s&&(s=1e-4),a>0&&1e-4>n*a&&(n=1e-4/a);var r=new L.LayerGroup(null),l=this._layerControl;r.notReady=!0,l&&(l.addOverlay(r,t.name),l.options.collapsed&&l._expand()),L.IIPUtils.requestURI(L.Util.template(t.uri,L.extend({ra:e.lng.toFixed(6),dec:e.lat.toFixed(6),dra:n.toFixed(4),ddec:s.toFixed(4),nmax:t.nmax})),"getting "+t.service+" data",function(e,o){i._loadCatalog(t,r,e,o)},this,!0)},_loadCatalog:function(t,i,e,o){if(4===o.readyState)if(200===o.status){var a=o.responseText,n=t.toGeoJSON(a),s=L.geoJson(n,{onEachFeature:function(i,e){i.properties&&i.properties.mags&&e.bindPopup(t._popup(i))},pointToLayer:function(i,e){return L.circleMarker(e,{radius:i.properties.mags[0]?8+t.maglim-i.properties.mags[0]:8})},style:function(){return{color:t.color}}});s.addTo(e._map);var r=e._layerControl;r&&(r.removeLayer(i),r.addOverlay(s,t.name+" ("+n.features.length.toString()+" entries)"),r.options.collapsed&&r._collapse())}else alert("There was a problem with the request to "+t.service+".")},getProfile:function(){L.drawLocal.draw.handlers.polyline.tooltip.cont="Click to end drawing line.";var t=new L.Draw.Line(this._map),i=this;this._map.on("draw:created",function(e){var o=e.layer,a=document.createElement("div");o.addTo(i._map),t.removeHooks(),a.id="leaflet-profile-plot";var n=document.createElement("div");n.className="leaflet-control-activity",a.appendChild(n),o.bindPopup(a,{minWidth:16,maxWidth:1024}).openPopup();var s=i._map.options.crs.options.nzoom-1,r=i._map.project(o._latlngs[0],s),l=i._map.project(o._latlngs[1],s);L.IIPUtils.requestURI(i._layer._url.replace(/\&.*$/g,"")+"&PFL="+s.toString()+":"+r.x.toFixed(0)+","+r.y.toFixed(0)+"-"+l.x.toFixed(0)+","+l.y.toFixed(0),"getting IIP layer profile",i._plotProfile,o)}),t.addHooks()},_plotProfile:function(t,i){if(4===i.readyState&&200===i.status){var e=JSON.parse(i.responseText),o=e.profile,a=d3.range(o.length),n=(d3.zip(a,o),document.getElementById("leaflet-profile-plot")),s=n.style;n.removeChild(n.childNodes[0]);var r=t._map._layerControl;r&&r.addOverlay(t,"Image profile"),s.left="20%",s.bottom="20%",s.width=640,s.height=480,s.backgroundColor="white";var l={top:20,right:10,bottom:30,left:50},p=640-l.left-l.right,c=480-l.top-l.bottom,h=d3.scale.linear().range([0,p]),d=d3.scale.linear().range([c,0]),u=d3.svg.axis().scale(h).orient("bottom"),m=d3.svg.axis().scale(d).orient("left"),g=d3.svg.line().x(function(t,i){return h(a[i])}).y(function(t){return d(t)}),_=d3.select("#leaflet-profile-plot").append("svg").attr("width",p+l.left+l.right).attr("height",c+l.top+l.bottom).append("g").attr("transform","translate("+l.left+","+l.top+")");h.domain(d3.extent(a)),d.domain(d3.extent(o)),_.append("g").attr("class","x axis").attr("transform","translate(0,"+c+")").call(u).append("text").text("Pixels"),_.append("g").attr("class","y axis").call(m).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Pixel value (ADU)"),_.append("path").datum(o).attr("class","line").attr("d",g),t._popup.update()}}}),L.control.iip.overlay=function(t){return new L.Control.IIP.Overlay(t)},"undefined"!=typeof require)var $=require("jquery-browser");L.Control.Layers.IIP=L.Control.Layers.extend({options:{title:"overlay menu",collapsed:!0,position:"topright"},onAdd:function(t){return t._layerControl=this,this._initLayout(),this._update(),t.on("layeradd",this._onLayerChange,this).on("layerremove",this._onLayerChange,this),this._container},_addItem:function(t){var i=this,e=L.DomUtil.create("div","leaflet-control-layers-item"),o=L.DomUtil.create("div","leaflet-control-layers-select",e);if(t.layer.notReady){L.DomUtil.create("div","leaflet-control-activity",o)}else{var a,n=this._map.hasLayer(t.layer);t.overlay?(a=document.createElement("input"),a.type="checkbox",a.className="leaflet-control-layers-selector",a.defaultChecked=n):a=this._createRadioElement("leaflet-base-layers",n),a.layerId=L.stamp(t.layer),L.DomEvent.on(a,"click",this._onInputClick,this),o.appendChild(a)}var s=L.DomUtil.create("div","leaflet-control-layers-name",e);s.innerHTML=" "+t.name;var r=L.DomUtil.create("input","leaflet-control-layers-trash",e);r.type="button",L.DomEvent.on(r,"click",function(){i.removeLayer(t.layer),t.notReady||i._map.removeLayer(t.layer)},this);var l=t.overlay?this._overlaysList:this._baseLayersList;return l.appendChild(e),e},_onInputClick:function(){var t,i,e,o=this._form.getElementsByTagName("input"),a=o.length;for(this._handlingClick=!0,t=0;a>t;t++)i=o[t],"layerId"in i&&(e=this._layers[i.layerId],i.checked&&!this._map.hasLayer(e.layer)?this._map.addLayer(e.layer):!i.checked&&this._map.hasLayer(e.layer)&&this._map.removeLayer(e.layer));this._handlingClick=!1},_addDialogLine:function(t,i){var e=L.DomUtil.create("div",this._className+"-element",i),o=L.DomUtil.create("span",this._className+"-label",e);return o.innerHTML=t,e}}),L.control.layers.iip=function(t,i){return new L.Control.Layers.IIP(t,i)},L.Control.ExtraMap=L.Control.extend({options:{position:"bottomright",toggleDisplay:!0,zoomLevelOffset:-5,zoomLevelFixed:!1,zoomAnimation:!1,autoToggleDisplay:!1,width:150,height:150},hideText:"Hide map",showText:"Show map",initialize:function(t,i){L.Util.setOptions(this,i),this._layer=t},onAdd:function(t){return this._mainMap=t,this._container=L.DomUtil.create("div","leaflet-control-extramap"),this._container.style.width=this.options.width+"px",this._container.style.height=this.options.height+"px",L.DomEvent.disableClickPropagation(this._container),L.DomEvent.on(this._container,"mousewheel",L.DomEvent.stopPropagation),this._extraMap=new L.Map(this._container,{attributionControl:!1,zoomControl:!1,zoomAnimation:this.options.zoomAnimation,autoToggleDisplay:this.options.autoToggleDisplay,touchZoom:!this.options.zoomLevelFixed,scrollWheelZoom:!this.options.zoomLevelFixed,doubleClickZoom:!this.options.zoomLevelFixed,boxZoom:!this.options.zoomLevelFixed}),this._layer.addTo(this._extraMap),this._mainMapMoving=!1,this._extraMapMoving=!1,this._userToggledDisplay=!1,this._minimized=!1,this.options.toggleDisplay&&this._addToggleButton(),this._layer.once("metaload",function(){var t=(this._mainMap.getPixelBounds(),this._getMapLatLngBounds(this._mainMap));this._aimingRect=L.polygon(t,{color:"#ff7800",weight:1,clickable:!1}).addTo(this._extraMap),this._shadowRect=L.polygon(t,{color:"#B15300",weight:1,clickable:!1,opacity:0,fillOpacity:0}).addTo(this._extraMap),this._mainMap.on("moveend",this._onMainMapMoved,this),this._mainMap.on("move",this._onMainMapMoving,this),this._extraMap.on("movestart",this._onExtraMapMoveStarted,this),this._extraMap.on("move",this._onExtraMapMoving,this),this._extraMap.on("moveend",this._onExtraMapMoved,this),this._extraMap.setView(this._mainMap.getCenter(),this._decideZoom(!0)),this._setDisplay(this._decideMinimized())
},this),this._container},addTo:function(t){return L.Control.prototype.addTo.call(this,t),this},onRemove:function(){this._mainMap.off("moveend",this._onMainMapMoved,this),this._mainMap.off("move",this._onMainMapMoving,this),this._extraMap.off("moveend",this._onExtraMapMoved,this),this._extraMap.removeLayer(this._layer)},_getMapLatLngBounds:function(t){var i=t.getPixelBounds(),e=i.min,o=i.max;return[t.unproject([e.x,e.y]),t.unproject([o.x,e.y]),t.unproject([o.x,o.y]),t.unproject([e.x,o.y])]},_addToggleButton:function(){this._toggleDisplayButton=this.options.toggleDisplay?this._createButton("",this.hideText,"leaflet-control-extramap-toggle-display",this._container,this._toggleDisplayButtonClicked,this):void 0},_createButton:function(t,i,e,o,a,n){var s=L.DomUtil.create("a",e,o);s.innerHTML=t,s.href="#",s.title=i;var r=L.DomEvent.stopPropagation;return L.DomEvent.on(s,"click",r).on(s,"mousedown",r).on(s,"dblclick",r).on(s,"click",L.DomEvent.preventDefault).on(s,"click",a,n),s},_toggleDisplayButtonClicked:function(){this._userToggledDisplay=!0,this._minimized?(this._restore(),this._toggleDisplayButton.title=this.hideText):(this._minimize(),this._toggleDisplayButton.title=this.showText)},_setDisplay:function(t){t!==this._minimized&&(this._minimized?this._restore():this._minimize())},_minimize:function(){this.options.toggleDisplay?(this._container.style.width="19px",this._container.style.height="19px",this._toggleDisplayButton.className+=" minimized"):this._container.style.display="none",this._minimized=!0},_restore:function(){this.options.toggleDisplay?(this._container.style.width=this.options.width+"px",this._container.style.height=this.options.height+"px",this._toggleDisplayButton.className=this._toggleDisplayButton.className.replace(/(?:^|\s)minimized(?!\S)/g,"")):this._container.style.display="block",this._minimized=!1},_onMainMapMoved:function(){this._extraMapMoving?this._extraMapMoving=!1:(this._mainMapMoving=!0,this._extraMap.setView(this._mainMap.getCenter(),this._decideZoom(!0)),this._setDisplay(this._decideMinimized())),this._aimingRect.setLatLngs(this._getMapLatLngBounds(this._mainMap))},_onMainMapMoving:function(){this._aimingRect.setLatLngs(this._getMapLatLngBounds(this._mainMap))},_onExtraMapMoveStarted:function(){this._lastAimingRectPosition=this._aimingRect.getLatLngs()},_onExtraMapMoving:function(){!this._mainMapMoving&&this._lastAimingRectPosition&&(this._shadowRect.setLatLngs(this._lastAimingRectPosition),this._shadowRect.setStyle({opacity:1,fillOpacity:.3}))},_onExtraMapMoved:function(){this._mainMapMoving?this._mainMapMoving=!1:(this._extraMapMoving=!0,this._mainMap.setView(this._extraMap.getCenter(),this._decideZoom(!1)),this._shadowRect.setStyle({opacity:0,fillOpacity:0}))},_decideZoom:function(t){return this.options.zoomLevelFixed?t?this.options.zoomLevelFixed:this._mainMap.getZoom():t?this._mainMap.getZoom()+this.options.zoomLevelOffset:this._extraMap.getZoom()-this.options.zoomLevelOffset},_decideMinimized:function(){return this._userToggledDisplay?this._minimized:this.options.autoToggleDisplay?this._mainMap.getBounds().contains(this._extraMap.getBounds())?!0:!1:this._minimized}}),L.Map.mergeOptions({extraMapControl:!1}),L.Map.addInitHook(function(){this.options.extraMapControl&&(this.extraMapControl=(new L.Control.ExtraMap).addTo(this))}),L.control.extramap=function(t){return new L.Control.ExtraMap(t)};