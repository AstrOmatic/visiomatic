/*
#	Copyright:    (C) 2013 Emmanuel Bertin - IAP/CNRS/UPMC
#                        Chiara Marmo - IDES/Paris-Sud,
#                        Ruven Pillay - C2RMF/CNRS
#
#	License:		GNU General Public License
#
#	This Leaflet plug-in is free software: you can redistribute it and/or modify
#	it under the terms of the GNU General Public License as published by
#	the Free Software Foundation, either version 3 of the License, or
# 	(at your option) any later version.
#	This plug-in is distributed in the hope that it will be useful,
#	but WITHOUT ANY WARRANTY; without even the implied warranty of
#	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#	GNU General Public License for more details.
#	You should have received a copy of the GNU General Public License
#	along with this plug-in. If not, see <http://www.gnu.org/licenses/>.
*/

if(L.IIPUtils={REG_PDEC:"(\\d+\\.\\d*)",REG_FLOAT:"([-+]?[0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)",requestURI:function(t,i,e,a){var o;if(window.XMLHttpRequest)o=new XMLHttpRequest;else if(window.ActiveXObject)try{o=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){try{o=new ActiveXObject("Microsoft.XMLHTTP")}catch(n){}}return o?(o.open("GET",t),o.onreadystatechange=function(){e(a,o)},o.send(),void 0):(alert("Giving up: Cannot create an XMLHTTP instance for "+i),!1)},distance:function(t,i){var e=Math.PI/180,a=t.lat*e,o=i.lat*e,n=o-a,s=(i.lng-t.lng)*e,r=Math.sin(n/2),l=Math.sin(s/2),p=r*r+l*l*Math.cos(a)*Math.cos(o);return 360*Math.atan2(Math.sqrt(p),Math.sqrt(1-p))/Math.PI}},L.Projection.WCS=L.Class.extend({bounds:L.bounds([0,-90],[360,90]),_phiThetaToRADec:function(t){var i=this.projparam,e=Math.PI/180,a=180/Math.PI,o=t.lat*e,n=Math.cos(o),s=Math.sin(o),r=i.celpole.lat*e,l=Math.cos(r),p=Math.sin(r),h=(t.lng-i.natpole.lng)*e,c=Math.cos(h),u=s*p+n*l*c;return u>1?u=1:-1>u&&(u=-1),new L.LatLng(Math.asin(u)*a,i.celpole.lng+Math.atan2(-n*Math.sin(h),s*l-n*p*c)*a)},_raDecToPhiTheta:function(t){var i=this.projparam,e=Math.PI/180,a=180/Math.PI,o=(t.lng-i.celpole.lng)*e,n=Math.cos(o),s=Math.sin(o),r=t.lat*e,l=Math.cos(r),p=Math.sin(r),h=i.celpole.lat*e,c=Math.cos(h),u=Math.sin(h),d=p*u+l*c*n;return d>1?d=1:-1>d&&(d=-1),new L.LatLng(Math.asin(d)*a,i.natpole.lng+Math.atan2(-l*s,p*c-l*u*n)*a)},_pixToRed:function(t){var i=this.projparam,e=i.cd,a=t.subtract(i.crpix);return new L.Point(a.x*e[0][0]+a.y*e[0][1],a.x*e[1][0]+a.y*e[1][1])},_redToPix:function(t){var i=this.projparam,e=i.cdinv;return new L.point(t.x*e[0][0]+t.y*e[0][1],t.x*e[1][0]+t.y*e[1][1]).add(i.crpix)},_invertCD:function(t){var i=1/(t[0][0]*t[1][1]-t[0][1]*t[1][0]);return[[t[1][1]*i,-t[0][1]*i],[-t[1][0]*i,t[0][0]*i]]}}),L.Projection.WCS.zenithal=L.Projection.WCS.extend({paraminit:function(t){this.projparam=t,t.cdinv=this._invertCD(t.cd),t.natfid=new L.LatLng(0,90),t.celpole=t.crval},project:function(t){var i=this._raDecToPhiTheta(t);return i.lat=this._thetaToR(i.lat),this._redToPix(this._phiRToRed(i))},unproject:function(t){var i=this._redToPhiR(this._pixToRed(t));return i.lat=this._rToTheta(i.lat),this._phiThetaToRADec(i)},_redToPhiR:function(t){return new L.LatLng(Math.sqrt(t.x*t.x+t.y*t.y),180*Math.atan2(t.x,-t.y)/Math.PI)},_phiRToRed:function(t){var i=Math.PI/180,e=t.lng*i;return new L.Point(t.lat*Math.sin(e),-t.lat*Math.cos(e))}}),L.Projection.WCS.TAN=L.Projection.WCS.zenithal.extend({code:"TAN",_rToTheta:function(t){return 180*Math.atan2(180,Math.PI*t)/Math.PI},_thetaToR:function(t){return 180/Math.PI*Math.tan((90-t)*Math.PI/180)}}),L.Projection.WCS.ZEA=L.Projection.WCS.zenithal.extend({code:"ZEA",_rToTheta:function(t){var i=Math.PI*t/360;return Math.abs(i)<1?90-2*Math.asin(i)*180/Math.PI:90},_thetaToR:function(t){return 360/Math.PI*Math.sin((90-t)*Math.PI/360)}}),L.CRS.WCS=L.extend({},L.CRS,{code:"WCS",options:{ctype:{x:"RA--TAN",y:"DEC--TAN"},naxis:[256,256],nzoom:9,crpix:[129,129],crval:[0,0],cd:[[1,0],[0,1]],natpole:[90,180],tileSize:[256,256]},initialize:function(t,i){switch(i=L.setOptions(this,i),this.tileSize=L.point(i.tileSize),this.nzoom=i.nzoom,this.projection=i.projection,this.ctype=i.ctype,this.naxis=L.point(i.naxis,!0),this.projparam=new this.paraminit(i),t&&this._readWCS(t),this.ctype.x.substr(5,3)){case"ZEA":this.projection=new L.Projection.WCS.ZEA;break;case"TAN":this.projection=new L.Projection.WCS.TAN;break;default:this.projection=new L.Projection.WCS.TAN}this.transformation=new L.Transformation(1,-.5,-1,this.naxis.y+.5),this.projection.paraminit(this.projparam),this.code+=":"+this.projection.code},paraminit:function(t){this.crpix=L.point(t.crpix),this.crval=L.latLng(t.crval),this.cd=[[t.cd[0][0],t.cd[0][1]],[t.cd[1][0],t.cd[1][1]]],this.natpole=L.latLng(t.natpole),this.celpole=L.latLng(t.celpole),this.natfid=L.latLng(t.natfid)},pointToLatLng:function(t,i){var e=this.scale(i),a=this.transformation.untransform(t,e);return this.projection.unproject(a)},scale:function(t){return Math.pow(2,t-this.nzoom+1)},_readWCS:function(t){var i,e=this._readFITSKey,a=this.projparam;(i=e("CTYPE1",t))&&(this.ctype.x=i),(i=e("CTYPE2",t))&&(this.ctype.y=i),(i=e("NAXIS1",t))&&(this.naxis.x=parseInt(i,10)),(i=e("NAXIS2",t))&&(this.naxis.y=parseInt(i,10)),(i=e("CRPIX1",t))&&(a.crpix.x=parseFloat(i,10)),(i=e("CRPIX2",t))&&(a.crpix.y=parseFloat(i,10)),(i=e("CRVAL1",t))&&(a.crval.lng=parseFloat(i,10)),(i=e("CRVAL2",t))&&(a.crval.lat=parseFloat(i,10)),(i=e("CD1_1",t))&&(a.cd[0][0]=parseFloat(i,10)),(i=e("CD1_2",t))&&(a.cd[0][1]=parseFloat(i,10)),(i=e("CD2_1",t))&&(a.cd[1][0]=parseFloat(i,10)),(i=e("CD2_2",t))&&(a.cd[1][1]=parseFloat(i,10))},_readFITSKey:function(t,i){var e=t.trim().toUpperCase().substr(0,8),a=8-e.length,o=new RegExp(e+"\\ {"+a.toString()+"}=\\ *(?:'(\\S*)\\ *'|([-+]?[0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?))"),n=o.exec(i);return n?n[1]?n[1]:n[2]:null}}),L.CRS.WCS=L.Class.extend(L.CRS.WCS),L.CRS.wcs=function(t){return new L.CRS.WCS(t)},L.Control.WCS=L.Control.extend({options:{position:"bottomleft",units:"HMS"},onAdd:function(t){var i=this._wcsinput=L.DomUtil.create("input","leaflet-control-wcs");return L.DomEvent.disableClickPropagation(i),i.type="text","webkitSpeechRecognition"in window&&i.setAttribute("x-webkit-speech","x-webkit-speech"),t.on("drag",this._onDrag,this),L.DomEvent.on(i,"change",this._onInputChange,this),this._wcsinput},onRemove:function(t){t.off("drag",this._onDrag)},_onDrag:function(){var t=this._map.getCenter();this._wcsinput.value="HMS"===this.options.units?this._latLngToHMSDMS(t):t.lng.toFixed(5)+" , "+t.lat.toFixed(5)},_latLngToHMSDMS:function(t){var i=(t.lng+360)/360;i=24*(i-Math.floor(i));var e=Math.floor(i),a=60*(i-e),o=Math.floor(a),n=60*(a-o);n>=60&&(o++,n=0),60===o&&(e++,o=0);var s=e.toString()+":"+(10>o?"0":"")+o.toString()+":"+(10>n?"0":"")+n.toFixed(3),r=Math.abs(t.lat),l=t.lat<0?"-":"+",p=Math.floor(r);return a=60*(r-p),o=Math.floor(a),n=60*(a-o),n>=60&&(o++,n=0),60===o&&(e++,o=0),s+" "+l+(10>p?"0":"")+p.toString()+":"+(10>o?"0":"")+o.toString()+":"+(10>n?"0":"")+n.toFixed(2)},_onInputChange:function(){var t=/^(\d+\.?\d*)\s*,?\s*\+?(-?\d+\.?\d*)/g,i=this._wcsinput.value,e=t.exec(i);e&&e.length>=3?this._map.panTo({lat:Number(e[2]),lng:Number(e[1])}):L.IIPUtils.requestURI("/cgi-bin/nph-sesame/-oI?"+i,"getting coordinates for "+i,this._getCoordinates,this,!0)},_getCoordinates:function(t,i){if(4===i.readyState)if(200===i.status){var e=/J\s(\d+\.?\d*)\s*,?\s*\+?(-?\d+\.?\d*)/g,a=i.responseText,o=e.exec(a);o&&o.length>=3?(t._map.panTo({lat:Number(o[2]),lng:Number(o[1])}),t._onDrag()):alert(a+": Unknown location")}else alert("There was a problem with the request to the Sesame service at CDS")}}),L.Map.mergeOptions({positionControl:!1}),L.Map.addInitHook(function(){this.options.positionControl&&(this.positionControl=new L.Control.MousePosition,this.addControl(this.positionControl))}),L.control.wcs=function(t){return new L.Control.WCS(t)},L.Control.Scale.WCS=L.Control.Scale.extend({options:{position:"bottomleft",maxWidth:128,metric:!1,imperial:!1,degrees:!0,pixels:!0,planetRadius:6378137,updateWhenIdle:!1},_addScales:function(t,i,e){t.metric&&(this._mScale=L.DomUtil.create("div",i,e)),t.imperial&&(this._iScale=L.DomUtil.create("div",i,e)),t.degrees&&(this._dScale=L.DomUtil.create("div",i,e)),t.pixels&&(this._pScale=L.DomUtil.create("div",i,e)),this.angular=t.metric||t.imperial||t.degrees},_update:function(){var t=this.options,i=this._map;if(t.pixels){var e=i.options.crs;if(e.options&&e.options.nzoom){var a=Math.pow(2,e.options.nzoom-1-i.getZoom());this._updatePixels(a*t.maxWidth)}}if(this.angular){var o=i.getCenter(),n=Math.cos(o.lat*Math.PI/180),s=Math.sqrt(this._jacobian(o))*n,r=s*t.maxWidth;t.metric&&this._updateMetric(r*Math.PI/180*t.planetRadius),t.imperial&&this._updateImperial(r*Math.PI/180*t.planetRadius),t.degrees&&this._updateDegrees(r)}},_jacobian:function(t){var i=this._map,e=i.project(t),a=i.unproject(e.add([10,0])),o=i.unproject(e.add([0,10]));return.01*Math.abs((a.lng-t.lng)*(o.lat-t.lat)-(o.lng-t.lng)*(a.lat-t.lat))},_updatePixels:function(t){var i=this._pScale;if(t>1e6){var e=1e-6*t,a=this._getRoundNum(e);this._updateScale(i,a+" Mpx",a/e)}else if(t>1e3){var o=.001*t,n=this._getRoundNum(o);this._updateScale(i,n+" kpx",n/o)}else{var s=this._getRoundNum(t);this._updateScale(i,s+" px",s/t)}},_updateDegrees:function(t){var i=3600*t,e=this._dScale;if(1>i){var a=1e3*i,o=this._getRoundNum(a);this._updateScale(e,o+" mas",o/a)}else if(60>i){var n=this._getRoundNum(i);this._updateScale(e,n+" &#34;",n/i)}else if(3600>i){var s=60*t,r=this._getRoundNum(s);this._updateScale(e,r+" &#39;",r/s)}else{var l=this._getRoundNum(t);this._updateScale(e,l+" &#176;",l/t)}}}),L.control.scale.wcs=function(t){return new L.Control.Scale.WCS(t)},L.TileLayer.IIP=L.TileLayer.extend({options:{minZoom:0,maxZoom:null,maxNativeZoom:18,contrast:1,gamma:1,cMap:"grey",invertCMap:!1,quality:90},iipdefault:{contrast:1,gamma:1,cMap:"grey",invertCMap:!1,minValue:[],maxValue:[],quality:90},initialize:function(t,i){i=L.setOptions(this,i),i.detectRetina&&L.Browser.retina&&i.maxZoom>0&&(i.tileSize=Math.floor(i.tileSize/2),i.zoomOffset++,i.minZoom=Math.max(0,i.minZoom),i.maxZoom--),this._url=t.replace(/\&.*$/g,""),"string"==typeof i.subdomains&&(i.subdomains=i.subdomains.split("")),this.iipTileSize={x:256,y:256},this.iipImageSize=[],this.iipImageSize[0]=this.iipTileSize,this.iipGridSize=[],this.iipGridSize[0]={x:1,y:1},this.iipBPP=8,this.iipMinZoom=this.options.minZoom,this.iipMaxZoom=this.options.maxZoom,this.iipContrast=this.options.contrast,this.iipGamma=this.options.gamma,this.iipCMap=this.options.cMap,this.iipInvertCMap=this.options.invertCMap,this.iipMinValue=[],this.iipMinValue[0]=0,this.iipMaxValue=[],this.iipMaxValue[0]=255,this.iipQuality=this.options.quality,this.getIIPMetaData(this._url)},getIIPMetaData:function(t){L.IIPUtils.requestURI(t+"&obj=IIP,1.0&obj=max-size&obj=tile-size&obj=resolution-number&obj=bits-per-channel&obj=min-max-sample-values&obj=subject","getting IIP metadata",this._parseMetadata,this)},_parseMetadata:function(t,i){if(4===i.readyState)if(200===i.status){var e=i.responseText,a=t._readIIPKey(e,"IIP",L.IIPUtils.REG_PDEC);a||alert("Error: Unexpected response from IIP server "+t._url.replace(/\?.*$/g,"")),a=t._readIIPKey(e,"Max-size","(\\d+)\\s+(\\d+)");var o={x:parseInt(a[1],10),y:parseInt(a[2],10)};a=t._readIIPKey(e,"Tile-size","(\\d+)\\s+(\\d+)"),t.iipTileSize={x:parseInt(a[1],10),y:parseInt(a[2],10)},a=t._readIIPKey(e,"Resolution-number","(\\d+)"),t.iipMaxZoom=parseInt(a[1],10)-1,t.iipMinZoom=0,t.iipMinZoom>t.options.minZoom&&(t.options.minZoom=t.iipMinZoom),t.options.maxZoom||(t.options.maxZoom=t.iipMaxZoom+6),t.options.maxNativeZoom=t.iipMaxZoom;for(var n=0;n<=t.iipMaxZoom;n++)t.iipImageSize[n]={x:Math.floor(o.x/Math.pow(2,t.iipMaxZoom-n)),y:Math.floor(o.y/Math.pow(2,t.iipMaxZoom-n))},t.iipGridSize[n]={x:Math.ceil(t.iipImageSize[n].x/t.iipTileSize.x),y:Math.ceil(t.iipImageSize[n].y/t.iipTileSize.y)};for(n=t.iipMaxZoom;n<=t.options.maxZoom;n++)t.iipGridSize[n]=t.iipGridSize[t.iipMaxZoom];a=t._readIIPKey(e,"Bits-per-channel","(\\d+)"),t.iipBPP=parseInt(a[1],10),t.iipGamma=t.iipBPP>=32?2.2:1,a=t._readIIPKey(e,"Min-Max-sample-values","\\s*(.*)");for(var s=a[1].split(/ \s* /),r=s.length/2,l=0,p=0;r>p;p++)t.iipdefault.minValue[p]=t.iipMinValue[p]=parseFloat(s[l++]);for(p=0;r>p;p++)t.iipdefault.maxValue[p]=t.iipMaxValue[p]=parseFloat(s[l++]);t.options.bounds&&(t.options.bounds=L.latLngBounds(t.options.bounds)),t.wcs=new L.CRS.WCS(e,{nzoom:t.iipMaxZoom+1,tileSize:t.iipTileSize}),t.iipMetaReady=!0,t.fire("metaload")}else alert("There was a problem with the IIP metadata request.")},_readIIPKey:function(t,i,e){var a=new RegExp(i+":"+e);return a.exec(t)},addTo:function(t){return this.iipMetaReady?this._addToMap(t):this.once("metaload",function(){this._addToMap(t)},this),this},_addToMap:function(t){var i,e;t._prevcrs&&this.wcs!==t.options.crs&&t._loaded?(i=t.getCenter(),e=t.getZoom()):(i=this.wcs.projparam.crval,e=1),t._prevcrs=t.options.crs=this.wcs,t.setView(i,e,{reset:!0,animate:!1}),L.TileLayer.prototype.addTo.call(this,t)},_resetWrap:function(){var t=this._map,i=t.options.crs;if(!i.infinite){var e=this._getTileSize();i.wrapLng&&(this._wrapLng=[Math.floor(t.project([0,i.wrapLng[0]]).x/e.x),Math.ceil(t.project([0,i.wrapLng[1]]).x/e.x)]),i.wrapLat&&(this._wrapLat=[Math.floor(t.project([i.wrapLat[0],0]).y/e.y),Math.ceil(t.project([i.wrapLat[1],0]).y/e.y)])}},_getTileSizeFac:function(){var t=this._map,i=t.getZoom(),e=this.options.maxNativeZoom;return e&&i>e?Math.round(t.getZoomScale(i)/t.getZoomScale(e)):1},_getTileSize:function(){var t=this._getTileSizeFac();return{x:this.iipTileSize.x*t,y:this.iipTileSize.y*t}},_isValidTile:function(t){var i=this._getZoomForUrl();if(t.x<0||t.x>=this.iipGridSize[i].x||t.y<0||t.y>=this.iipGridSize[i].y)return!1;var e=this._map.options.crs;if(!e.infinite){var a=this._tileNumBounds;if(!e.wrapLng&&(t.x<a.min.x||t.x>a.max.x)||!e.wrapLat&&(t.y<a.min.y||t.y>a.max.y))return!1}if(!this.options.bounds)return!0;var o=this._tileCoordsToBounds(t);return L.latLngBounds(this.options.bounds).intersects(o)},_update:function(){if(this._map){var t=this._map,i=t.getPixelBounds(),e=t.getZoom(),a=this._getTileSize();if(!(e>this.options.maxZoom||e<this.options.minZoom)){var o=L.bounds(this._vecDiv(i.min.clone(),a)._floor(),this._vecDiv(i.max.clone(),a)._floor());this._addTiles(o),this.options.unloadInvisibleTiles&&this._removeOtherTiles(o)}}},_vecDiv:function(t,i){return t.x/=i.x,t.y/=i.y,t},_vecMul:function(t,i){return t.x*=i.x,t.y*=i.y,t},_getTilePos:function(t){return this._vecMul(t.clone(),this._getTileSize()).subtract(this._map.getPixelOrigin())},getTileUrl:function(t){var i=this._url,e=this._getZoomForUrl();return this.iipCMap!==this.iipdefault.cMap&&(i+="&CMP="+this.iipCMap),this.iipInvertCMap!==this.iipdefault.invertCMap&&(i+="&INV"),this.iipContrast!==this.iipdefault.contrast&&(i+="&CNT="+this.iipContrast.toString()),this.iipGamma!==this.iipdefault.gamma&&(i+="&GAM="+(1/this.iipGamma).toFixed(4)),(this.iipMinValue[0]!==this.iipdefault.minValue[0]||this.iipMaxValue[0]!==this.iipdefault.maxValue[0])&&(i+="&MINMAX=1,"+this.iipMinValue[0].toString()+","+this.iipMaxValue[0].toString()),this.iipQuality!==this.iipdefault.quality&&(i+="&QLT="+this.iipQuality.toString()),i+"&JTL="+(e-this.iipMinZoom).toString()+","+(t.x+this.iipGridSize[e].x*t.y).toString()},_initTile:function(t){if(L.DomUtil.addClass(t,"leaflet-tile"),this._getTileSizeFac()>1){var i=this._getTileSize();L.Browser.ie?t.style.msInterpolationMode="nearest-neighbor":t.style.imageRendering=L.Browser.chrome?"-webkit-optimize-speed":"-moz-crisp-edges",t.style.width=i.x+"px",t.style.height=i.y+"px"}t.onselectstart=L.Util.falseFn,t.onmousemove=L.Util.falseFn,L.Browser.ielt9&&this.options.opacity<1&&L.DomUtil.setOpacity(t,this.options.opacity),L.Browser.mobileWebkit3d&&(t.style.WebkitBackfaceVisibility="hidden")}}),L.tileLayer.iip=function(t,i){return new L.TileLayer.IIP(t,i)},L.Catalog={nmax:1e4,_csvToGeoJSON:function(t){var i=new RegExp("#|--|^$"),e=t.split("\n"),a={type:"FeatureCollection",features:[]};for(var o in e){var n=e[o];if(i.test(n)===!1){var s={type:"Feature",id:"",properties:{mags:[]},geometry:{type:"Point",coordinates:[0,0]}},r=s.geometry,l=s.properties,p=n.split(";");s.id=p[0],r.coordinates[0]=parseFloat(p[1]),r.coordinates[1]=parseFloat(p[2]);var h,c=p.slice(3);for(var u in c)h=parseFloat(c[u]),l.mags.push(isNaN(h)?"--":h);a.features.push(s)}}return a},_popup:function(t){var i="<div>";i+=this.objuri?'ID: <a href="'+L.Util.template(this.objuri,L.extend({ra:t.geometry.coordinates[0].toFixed(6),dec:t.geometry.coordinates[1].toFixed(6)}))+'" target="_blank">'+t.id+"</a></div>":"ID: "+t.id+"</div>",i+='<TABLE style="margin:auto;"><TBODY style="vertical-align:top;text-align:left;">';for(var e in this.properties)i+="<TR><TD>"+this.properties[e]+":</TD><TD>"+t.properties.mags[e].toString()+" "+this.units[e]+"</TD></TR>";return i+="</TBODY></TABLE>"}},L.Catalog.TwoMASS=L.extend({},L.Catalog,{name:"2MASS point sources",attribution:"2MASS All-Sky Catalog of Point Sources (Cutri et al., 2003)",color:"red",maglim:17,service:"CDS",uri:"/viz-bin/asu-tsv?&-mime=csv&-source=II/246&-out=2MASS,RAJ2000,DEJ2000,Jmag,Hmag,Kmag&-out.meta=&-c={ra},{dec},eq=J2000&-c.bd={dra},{ddec}&-sort=_Kmagr&-out.max={nmax}",toGeoJSON:L.Catalog._csvToGeoJSON,properties:["J","H","K"],units:["","",""],objuri:"http://vizier.u-strasbg.fr/viz-bin/VizieR-5?-source=II/246&-c={ra},{dec},eq=J2000&-c.rs=0.01"}),L.Catalog.SDSS=L.extend({},L.Catalog,{name:"SDSS release 9",attribution:"SDSS Photometric Catalog, Release 9 (Adelman-McCarthy et al., 2012)",color:"yellow",maglim:25,service:"CDS",uri:"/viz-bin/asu-tsv?&-mime=csv&-source=V/139&-out=SDSS9,RAJ2000,DEJ2000,umag,gmag,rmag,imag,zmag&-out.meta=&-c={ra},{dec}&-c.bd={dra},{ddec}&-sort=imag&-out.max={nmax}",toGeoJSON:L.Catalog._csvToGeoJSON,properties:["u","g","r","i","z"],units:["","","","",""],objuri:"http://vizier.u-strasbg.fr/viz-bin/VizieR-5?-source=V/139/sdss9&-c={ra},{dec},eq=J2000&-c.rs=0.01"}),L.Catalog.PPMXL=L.extend({},L.Catalog,{name:"PPMXL",attribution:"PPM-Extended, positions and proper motions by Roeser et al. 2008",color:"green",maglim:20,service:"CDS",uri:"/viz-bin/asu-tsv?&-mime=csv&-source=I/317&-out=PPMXL,RAJ2000,DEJ2000,Jmag,Hmag,Kmag,b1mag,b2mag,r1mag,r2mag,imag,pmRA,pmDE&-out.meta=&-c={ra},{dec}&-c.bd={dra},{ddec}&-sort=_r&-out.max={nmax}",toGeoJSON:L.Catalog._csvToGeoJSON,properties:["J","H","K","b<sub>1</sub>","b<sub>2</sub>","r<sub>1</sub>","r<sub>2</sub>","i","&#956;<sub>&#593;</sub> cos &#948;","&#956;<sub>&#948;</sub>"],units:["","","","","","","","","mas/yr","mas/yr"],objuri:"http://vizier.u-strasbg.fr/viz-bin/VizieR-5?-source=I/317&-c={ra},{dec},eq=J2000&-c.rs=0.01"}),L.Catalog.Abell=L.extend({},L.Catalog,{name:"Abell clusters",attribution:"Rich Clusters of Galaxies (Abell et al. 1989) ",color:"orange",maglim:30,service:"CDS",uri:"/viz-bin/asu-tsv?&-mime=csv&-source=VII/110A&-out=ACO,_RAJ2000,_DEJ2000,m10,Rich,Dclass&-out.meta=&-c={ra},{dec}&-c.bd={dra},{ddec}&-sort=m10&-out.max={nmax}",toGeoJSON:L.Catalog._csvToGeoJSON,properties:["m<sub>10</sub>","Richness","D<sub>class</sub>"],units:["","",""],objuri:"http://vizier.u-strasbg.fr/viz-bin/VizieR-5?-source=VII/110A&-c={ra},{dec},eq=J2000&-c.rs=0.2"}),L.Control.IIP=L.Control.extend({options:{title:"a control related to IIPImage",collapsed:!0,position:"topleft"},initialize:function(t,i){L.setOptions(this,i),this._className="leaflet-control-iip",this._id="leaflet-iipimage",this._layers=t},onAdd:function(){var t=this._className,i=this._id,e=this._container=L.DomUtil.create("div",t+" leaflet-bar");if(e.setAttribute("aria-haspopup",!0),L.DomEvent.disableClickPropagation(e).disableScrollPropagation(e),this._dialog=L.DomUtil.create("div",t+"-dialog",e),this.options.collapsed){L.Browser.android||L.DomEvent.on(e,"mouseover",this._expand,this).on(e,"mouseout",this._collapse,this);var a=this._toggle=L.DomUtil.create("a",t+"-toggle leaflet-bar",e);a.href="#",a.id=i+"-toggle",a.title=this.options.title,L.Browser.touch?L.DomEvent.on(a,"click",L.DomEvent.stop).on(a,"click",this._expand,this):L.DomEvent.on(a,"focus",this._expand,this),this._map.on("click",this._collapse,this)}else this._expand();return this._checkIIP(),this._map.on("baselayerchange",this._checkIIP,this),this._container},_checkIIP:function(){var t=this._layer=this._findActiveBaseLayer();t?this._reloadFlag?t.once("load",this._resetDialog,this):(this._initDialog(),this._reloadFlag=!0):this._prelayer&&this._prelayer.once("metaload",this._checkIIP,this)},_initDialog:function(){},_resetDialog:function(){this._dialog.innerHTML="",this._initDialog()},_addDialogLine:function(t){var i=L.DomUtil.create("div",this._className+"-element",this._dialog),e=L.DomUtil.create("span",this._className+"-label",i);return e.innerHTML=t,i},_expand:function(){L.DomUtil.addClass(this._container,this._className+"-expanded")},_collapse:function(){this._container.className=this._container.className.replace(" "+this._className+"-expanded","")},getActiveBaseLayer:function(){return this._activeBaseLayer},_findActiveBaseLayer:function(){var t=this._layers;this._prelayer=void 0;for(var i in t){var e=t[i];if(!e.overlay)if(e._map){if(this._map.hasLayer(e)&&e.iipdefault)return e}else this._prelayer=e}return void 0},_onInputChange:function(t,i,e){var a=i.split(/\[|\]/);a[1]?t[a[0]][parseInt(a[1],10)]=e:t[a[0]]=e,t.redraw()}}),L.control.iip=function(t,i){return new L.Control.IIP(t,i)},"undefined"!=typeof require)var $=require("jquery-browser");if(L.Control.IIP.Image=L.Control.IIP.extend({options:{title:"Image adjustment",collapsed:!0,cmap:"grey",position:"topleft"},initialize:function(t,i){L.setOptions(this,i),this._className="leaflet-control-iip",this._id="leaflet-iipimage",this._layers=t},_initDialog:function(){var t,i=this,e=this._className,a=this._layer,o=["grey","jet","cold","hot"];t=this._addDialogLine("LUT:");var n=L.DomUtil.create("input","leaflet-cmap-inv",t);n.id="leaflet-invertcmap",n.type="button";var s=L.DomUtil.create("span",e+"-cmaps",t),r=[];for(var l in o)r[l]=document.createElement("input"),r[l].className="leaflet-cmap-"+o[l],r[l].type="button",r[l].name="button",r[l].cmap=o[l],s.appendChild(r[l]),o[l]===this.options.cmap&&(r[l].checked="checked");$("."+e+"-cmaps").buttonset(),$("."+e+"-cmaps :button").click(function(){i._onInputChange(a,"iipCMap",this.cmap)}),$("#leaflet-invertcmap").button(),L.DomEvent.on(n,"click",function(){i._onInputChange(a,"iipInvertCMap",!a.iipInvertCMap);var t=a.iipInvertCMap?"scaleY(-1.0)":"none";for(var e in o)L.Browser.ie?r[e].style.msTransform=t:L.Browser.webkit?r[e].style.webkitTransform=t:r[e].style.transform=t},this);var p=((a.iipMaxValue[0]-a.iipMinValue[0])/100).toPrecision(1);t=this._addDialogLine("Min:");var h=L.DomUtil.create("input","",t);h.id="leaflet-minvalue",h.type="text",h.value=String(a.iipMinValue[0]),$("#"+h.id).spinner({stop:function(){i._onInputChange(a,"iipMinValue[0]",h.value)},icons:{down:"icon-minus",up:"icon-plus"},step:p}),L.DomEvent.on(h,"change",function(){i._onInputChange(a,"iipMinValue[0]",h.value)},this),t=this._addDialogLine("Max:");var c=L.DomUtil.create("input","",t);c.id="leaflet-maxvalue",c.type="text",c.value=String(a.iipMaxValue[0]),$("#"+c.id).spinner({stop:function(){i._onInputChange(a,"iipMaxValue[0]",c.value)},icons:{down:"icon-minus",up:"icon-plus"},step:p}),L.DomEvent.on(c,"change",function(){i._onInputChange(a,"iipMaxValue[0]",c.value)},this),t=this._addDialogLine("Gamma:");var u=L.DomUtil.create("input","",t);u.id="leaflet-gammavalue",u.type="text",u.value=String(a.iipGamma),$("#"+u.id).spinner({stop:function(){i._onInputChange(a,"iipGamma",u.value)},icons:{down:"icon-minus",up:"icon-plus"},step:.05,min:.5,max:5}),L.DomEvent.on(u,"change",function(){i._onInputChange(a,"iipGamma",u.value)},this),t=this._addDialogLine("Contrast:");var d=L.DomUtil.create("input","",t);d.id="leaflet-contrastvalue",d.type="text",d.value=String(a.iipContrast),$("#"+d.id).spinner({stop:function(){i._onInputChange(a,"iipContrast",d.value)},icons:{down:"icon-minus",up:"icon-plus"},step:.05,min:0,max:10}),L.DomEvent.on(d,"change",function(){i._onInputChange(a,"iipContrast",d.value)},this),t=this._addDialogLine("JPEG quality:");var m=L.DomUtil.create("input","",t);m.id="leaflet-qualvalue",m.type="text",m.value=String(a.iipQuality),$("#"+m.id).spinner({stop:function(){i._onInputChange(a,"iipQuality",m.value)},icons:{down:"icon-minus",up:"icon-plus"},step:1,min:0,max:100}),L.DomEvent.on(m,"change",function(){i._onInputChange(a,"iipQuality",m.value)},this)}}),L.control.iip.image=function(t,i){return new L.Control.IIP.Image(t,i)},"undefined"!=typeof require)var $=require("jquery-browser");if(L.Control.IIP.Overlay=L.Control.IIP.extend({options:{title:"overlay menu",collapsed:!0,position:"topleft"},initialize:function(t,i){L.setOptions(this,i),this._className="leaflet-control-iip",this._id="leaflet-iipoverlay",this._layers=t},_initDialog:function(){var t,i=this._className,e=[L.Catalog.TwoMASS,L.Catalog.SDSS,L.Catalog.PPMXL,L.Catalog.Abell];t=this._addDialogLine("CDS Catalog:");var a=L.DomUtil.create("input",i+"-catalogs",t);a.id="leaflet-catalog-colorpicker",a.type="text",a.value="yellow",$(document).ready(function(){$("#"+a.id).spectrum({showInput:!0,clickoutFiresChange:!0,move:function(t){a.value=t.toHexString()}})});var o=L.DomUtil.create("select",i+"-catalogs",t),n=document.createElement("option");n.value=null,n.text="Choose catalog:",n.disabled=!0,n.selected=!0,o.add(n,null);for(var s in e)n=document.createElement("option"),n.value=e[s],n.text=e[s].name,o.add(n,null);!L.Browser.android&&this.options.collapsed&&(L.DomEvent.on(o,"mousedown",function(){L.DomEvent.off(this._container,"mouseout",this._collapse,this),this.collapsedOff=!0},this),L.DomEvent.on(this._container,"mouseover",function(){this.collapsedOff&&(L.DomEvent.on(this._container,"mouseout",this._collapse,this),this.collapsedOff=!1)},this));var r=L.DomUtil.create("input",i+"-catalogs",t);r.type="button",r.value="Go",L.DomEvent.on(r,"click",function(){var t=o.selectedIndex-1;if(t>=0){var i=e[t];i.color=a.value,o.selectedIndex=0,this._getCatalog(i)}},this),t=this._addDialogLine("Profile:");var l=L.DomUtil.create("input",i+"-profile",t);l.id="leaflet-profile-colorpicker",l.type="text",l.value="magenta",$(document).ready(function(){$("#"+l.id).spectrum({showInput:!0,clickoutFiresChange:!0,move:function(t){l.value=t.toHexString()}})});var p=L.DomUtil.create("input",i+"-profile",t);p.type="button",p.value="Go",L.DomEvent.on(p,"click",this.getProfile,this)},_resetDialog:function(){},_getCatalog:function(t){var i=this,e=this._map.getCenter(),a=this._map.getBounds(),o=Math.abs(Math.cos(e.lat))*Math.PI/180,n=Math.abs(a.getWest()-a.getEast()),s=Math.abs(a.getNorth()-a.getSouth());1e-4>s&&(s=1e-4),o>0&&1e-4>n*o&&(n=1e-4/o);var r=new L.LayerGroup(null),l=this._map._layerControl;r.notReady=!0,l&&(l.addOverlay(r,t.name),l.options.collapsed&&l._expand()),L.IIPUtils.requestURI(L.Util.template(t.uri,L.extend({ra:e.lng.toFixed(6),dec:e.lat.toFixed(6),dra:n.toFixed(4),ddec:s.toFixed(4),nmax:t.nmax})),"getting "+t.service+" data",function(e,a){i._loadCatalog(t,r,e,a)},this,!0)},_loadCatalog:function(t,i,e,a){if(4===a.readyState)if(200===a.status){var o=a.responseText,n=t.toGeoJSON(o),s=L.geoJson(n,{onEachFeature:function(i,e){i.properties&&i.properties.mags&&e.bindPopup(t._popup(i))},pointToLayer:function(i,e){return L.circleMarker(e,{radius:i.properties.mags[0]?8+t.maglim-i.properties.mags[0]:8})},style:function(){return{color:t.color,weight:2}}});s.addTo(e._map);var r=e._map._layerControl;r&&(r.removeLayer(i),r.addOverlay(s,t.name+" ("+n.features.length.toString()+" entries)"),r.options.collapsed&&r._collapse())}else alert("There was a problem with the request to "+t.service+".")},getProfile:function(){L.drawLocal.draw.handlers.polyline.tooltip.cont="Click to end drawing line.";var t=new L.Draw.Line(this._map,{shapeOptions:{weight:7}}),i=this;this._map.on("draw:created",function(e){var a=e.layer,o=document.createElement("div");a.addTo(i._map),t.removeHooks(),o.id="leaflet-profile-plot";var n=document.createElement("div");n.className="leaflet-control-activity",o.appendChild(n),a.bindPopup(o,{minWidth:16,maxWidth:1024,closeOnClick:!1}).openPopup();var s=i._map.options.crs.options.nzoom-1,r=i._map.project(a._latlngs[0],s),l=i._map.project(a._latlngs[1],s);L.IIPUtils.requestURI(i._layer._url.replace(/\&.*$/g,"")+"&PFL="+s.toString()+":"+r.x.toFixed(0)+","+r.y.toFixed(0)+"-"+l.x.toFixed(0)+","+l.y.toFixed(0),"getting IIP layer profile",i._plotProfile,a)}),t.addHooks()},_plotProfile:function(t,i){if(4===i.readyState&&200===i.status){var e=JSON.parse(i.responseText),a=e.profile,o=t._map._layerControl,n=document.getElementById("leaflet-profile-plot");o&&o.addOverlay(t,"Image profile"),$(document).ready(function(){$.jqplot("leaflet-profile-plot",[a],{title:"Image profile",axes:{xaxis:{label:"position along line",labelRenderer:$.jqplot.CanvasAxisLabelRenderer,pad:1},yaxis:{label:"pixel values",labelRenderer:$.jqplot.CanvasAxisLabelRenderer,pad:1}},cursor:{show:!0,zoom:!0},seriesDefaults:{lineWidth:2,showMarker:!1}})}),n.removeChild(n.childNodes[0]),t._popup.update()}}}),L.control.iip.overlay=function(t){return new L.Control.IIP.Overlay(t)},"undefined"!=typeof require)var $=require("jquery-browser");L.Control.Layers.IIP=L.Control.Layers.extend({options:{title:"overlay menu",collapsed:!0,position:"topright",autoZIndex:!0},onAdd:function(t){return t._layerControl=this,this._initLayout(),this._update(),this._container},_addItem:function(t){var i=this,e=L.DomUtil.create("div","leaflet-control-layers-item"),a=L.DomUtil.create("div","leaflet-control-layers-select",e);if(t.layer.notReady)L.DomUtil.create("div","leaflet-control-activity",a);else{var o,n=this._map.hasLayer(t.layer);t.overlay?(o=document.createElement("input"),o.type="checkbox",o.className="leaflet-control-layers-selector",o.defaultChecked=n):o=this._createRadioElement("leaflet-base-layers",n),o.layerId=L.stamp(t.layer),L.DomEvent.on(o,"click",this._onInputClick,this),a.appendChild(o)}var s=L.DomUtil.create("div","leaflet-control-layers-name",e);s.innerHTML=" "+t.name;var r=L.DomUtil.create("input","leaflet-control-layers-trash",e);r.type="button",L.DomEvent.on(r,"click",function(){i.removeLayer(t.layer),t.notReady||i._map.removeLayer(t.layer)},this);var l=t.overlay?this._overlaysList:this._baseLayersList;return l.appendChild(e),e},_onLayerChange:function(t){this._handlingClick||this._update();var i=this._layers[L.stamp(t.target)].overlay,e=i?"add"===t.type?"overlayadd":"overlayremove":"add"===t.type?"baselayerchange":null;e&&this._map.fire(e,t.target)},_onInputClick:function(){var t,i,e,a=this._form.getElementsByTagName("input"),o=a.length;for(this._handlingClick=!0,t=0;o>t;t++)i=a[t],"layerId"in i&&(e=this._layers[i.layerId],i.checked&&!this._map.hasLayer(e.layer)?e.layer.addTo(this._map):!i.checked&&this._map.hasLayer(e.layer)&&this._map.removeLayer(e.layer));this._handlingClick=!1},_addDialogLine:function(t,i){var e=L.DomUtil.create("div",this._className+"-element",i),a=L.DomUtil.create("span",this._className+"-label",e);return a.innerHTML=t,e}}),L.control.layers.iip=function(t,i){return new L.Control.Layers.IIP(t,i)},L.Control.ExtraMap=L.Control.extend({options:{position:"bottomright",toggleDisplay:!0,zoomLevelOffset:-5,zoomLevelFixed:!1,zoomAnimation:!1,autoToggleDisplay:!1,width:150,height:150,aimingRectOptions:{color:"#ff7800",weight:1,clickable:!1,renderer:L.Canvas.instance},shadowRectOptions:{color:"#000000",weight:1,clickable:!1,opacity:0,fillOpacity:0}},hideText:"Hide map",showText:"Show map",initialize:function(t,i){L.Util.setOptions(this,i),this.options.aimingRectOptions.clickable=!1,this.options.shadowRectOptions.clickable=!1,this._layer=t},onAdd:function(t){return this._mainMap=t,this._container=L.DomUtil.create("div","leaflet-control-extramap"),this._container.style.width=this.options.width+"px",this._container.style.height=this.options.height+"px",L.DomEvent.disableClickPropagation(this._container),L.DomEvent.on(this._container,"mousewheel",L.DomEvent.stopPropagation),this._extraMap=new L.Map(this._container,{attributionControl:!1,zoomControl:!1,zoomAnimation:this.options.zoomAnimation,autoToggleDisplay:this.options.autoToggleDisplay,touchZoom:!this.options.zoomLevelFixed,scrollWheelZoom:!this.options.zoomLevelFixed,doubleClickZoom:!this.options.zoomLevelFixed,boxZoom:!this.options.zoomLevelFixed}),this._layer.addTo(this._extraMap),this._userToggledDisplay=!1,this._minimized=!1,this.options.toggleDisplay&&this._addToggleButton(),this._layer.once("metaload",function(){this._mainMap.whenReady(L.Util.bind(function(){this._extraMap.whenReady(L.Util.bind(function(){var t=this._getMapLatLngBounds(this._mainMap);this._aimingRect=L.polygon(t,this.options.aimingRectOptions).addTo(this._extraMap),this._shadowRect=L.polygon(t,this.options.shadowRectOptions).addTo(this._extraMap),this._mainMap.on("moveend",this._onMainMapMoved,this),this._mainMap.on("move",this._onMainMapMoving,this),this._extraMap.on("movestart",this._onExtraMapMoveStarted,this),this._extraMap.on("move",this._onExtraMapMoving,this),this._extraMap.on("moveend",this._onExtraMapMoved,this),this._extraMap.setView(this._mainMap.getCenter(),this._decideZoom(!0)),this._setDisplay(this._decideMinimized())
},this))},this))},this),this._container},addTo:function(t){return L.Control.prototype.addTo.call(this,t),this},onRemove:function(){this._mainMap.off("moveend",this._onMainMapMoved,this),this._mainMap.off("move",this._onMainMapMoving,this),this._extraMap.off("moveend",this._onExtraMapMoved,this),this._extraMap.removeLayer(this._layer)},_getMapLatLngBounds:function(t){var i=t.getPixelBounds(),e=i.min,a=i.max;return[t.unproject([e.x,e.y]),t.unproject([a.x,e.y]),t.unproject([a.x,a.y]),t.unproject([e.x,a.y])]},_addToggleButton:function(){this._toggleDisplayButton=this.options.toggleDisplay?this._createButton("",this.hideText,"leaflet-control-extramap-toggle-display",this._container,this._toggleDisplayButtonClicked,this):void 0},_createButton:function(t,i,e,a,o,n){var s=L.DomUtil.create("a",e,a);s.innerHTML=t,s.href="#",s.title=i;var r=L.DomEvent.stopPropagation;return L.DomEvent.on(s,"click",r).on(s,"mousedown",r).on(s,"dblclick",r).on(s,"click",L.DomEvent.preventDefault).on(s,"click",o,n),s},_toggleDisplayButtonClicked:function(){this._userToggledDisplay=!0,this._minimized?(this._restore(),this._toggleDisplayButton.title=this.hideText):(this._minimize(),this._toggleDisplayButton.title=this.showText)},_setDisplay:function(t){t!==this._minimized&&(this._minimized?this._restore():this._minimize())},_minimize:function(){this.options.toggleDisplay?(this._container.style.width="19px",this._container.style.height="19px",this._toggleDisplayButton.className+=" minimized"):this._container.style.display="none",this._minimized=!0},_restore:function(){this.options.toggleDisplay?(this._container.style.width=this.options.width+"px",this._container.style.height=this.options.height+"px",this._toggleDisplayButton.className=this._toggleDisplayButton.className.replace(/(?:^|\s)minimized(?!\S)/g,"")):this._container.style.display="block",this._minimized=!1},_onMainMapMoved:function(){this._extraMapMoving?this._extraMapMoving=!1:(this._mainMapMoving=!0,this._extraMap.setView(this._mainMap.getCenter(),this._decideZoom(!0)),this._setDisplay(this._decideMinimized())),this._aimingRect.setLatLngs(this._getMapLatLngBounds(this._mainMap))},_onMainMapMoving:function(){this._aimingRect.setLatLngs(this._getMapLatLngBounds(this._mainMap))},_onExtraMapMoveStarted:function(){this._lastAimingRectPosition=this._aimingRect.getLatLngs()},_onExtraMapMoving:function(){!this._mainMapMoving&&this._lastAimingRectPosition&&(this._shadowRect.setLatLngs(this._lastAimingRectPosition),this._shadowRect.setStyle({opacity:0,fillOpacity:0}))},_onExtraMapMoved:function(){this._mainMapMoving?this._mainMapMoving=!1:(this._extraMapMoving=!0,this._mainMap.setView(this._extraMap.getCenter(),this._decideZoom(!1)),this._shadowRect.setStyle({opacity:0,fillOpacity:0}))},_decideZoom:function(t){if(this.options.zoomLevelFixed)return t?this.options.zoomLevelFixed:this._mainMap.getZoom();if(t)return this._mainMap.getZoom()+this.options.zoomLevelOffset;var i,e=this._extraMap.getZoom()-this._mainMap.getZoom(),a=this._extraMap.getZoom()-this.options.zoomLevelOffset;return e>this.options.zoomLevelOffset&&this._mainMap.getZoom()<this._extraMap.getMinZoom()-this.options.zoomLevelOffset?this._extraMap.getZoom()>this._lastExtraMapZoom?(i=this._mainMap.getZoom()+1,this._extraMap.setZoom(this._extraMap.getZoom()-1)):i=this._mainMap.getZoom():i=a,this._lastExtraMapZoom=this._extraMap.getZoom(),i},_decideMinimized:function(){return this._userToggledDisplay?this._minimized:this.options.autoToggleDisplay?this._mainMap.getBounds().contains(this._extraMap.getBounds())?!0:!1:this._minimized}}),L.Map.mergeOptions({extraMapControl:!1}),L.Map.addInitHook(function(){this.options.extraMapControl&&(this.extraMapControl=(new L.Control.ExtraMap).addTo(this))}),L.control.extramap=function(t){return new L.Control.ExtraMap(t)};