/*
#	Copyright:    (C) 2013 Emmanuel Bertin - IAP/CNRS/UPMC
#                        Chiara Marmo - IDES/Paris-Sud,
#                        Ruven Pillay - C2RMF/CNRS
#
#	License:		GNU General Public License
#
#	This Leaflet plug-in is free software: you can redistribute it and/or modify
#	it under the terms of the GNU General Public License as published by
#	the Free Software Foundation, either version 3 of the License, or
# 	(at your option) any later version.
#	This plug-in is distributed in the hope that it will be useful,
#	but WITHOUT ANY WARRANTY; without even the implied warranty of
#	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#	GNU General Public License for more details.
#	You should have received a copy of the GNU General Public License
#	along with this plug-in. If not, see <http://www.gnu.org/licenses/>.
*/

if(L.Projection.WCS={_phiThetaToRADec:function(i,t){var e=L.LatLng.DEG_TO_RAD,o=L.LatLng.RAD_TO_DEG,a=i.lat*e,n=Math.cos(a),r=Math.sin(a),s=t.celpole.lat*e,l=Math.cos(s),p=Math.sin(s),h=(i.lng-t.natpole.lng)*e,c=Math.cos(h);return new L.LatLng(Math.asin(r*p+n*l*c)*o,t.celpole.lng+Math.atan2(-n*Math.sin(h),r*l-n*p*c)*o)},_raDecToPhiTheta:function(i,t){var e=L.LatLng.DEG_TO_RAD,o=L.LatLng.RAD_TO_DEG,a=(i.lng-t.celpole.lng)*e,n=Math.cos(a),r=Math.sin(a),s=i.lat*e,l=Math.cos(s),p=Math.sin(s),h=t.celpole.lat*e,c=Math.cos(h),u=Math.sin(h);return new L.LatLng(Math.asin(p*u+l*c*n)*o,t.natpole.lng+Math.atan2(-l*r,p*c-l*u*n)*o)},_pixToRed:function(i,t){var e=t.cd,o=i.subtract(t.crpix);return new L.Point(o.x*e[0][0]+o.y*e[0][1],o.x*e[1][0]+o.y*e[1][1])},_redToPix:function(i,t){var e=t.cdinv;return new L.point(i.x*e[0][0]+i.y*e[0][1],i.x*e[1][0]+i.y*e[1][1]).add(t.crpix)},_invertCD:function(i){var t=1/(i[0][0]*i[1][1]-i[0][1]*i[1][0]);return[[i[1][1]*t,-i[0][1]*t],[-i[1][0]*t,i[0][0]*t]]}},L.Projection.WCS.zenithal=L.extend({},L.Projection.WCS,{paraminit:function(i){i.cdinv=this._invertCD(i.cd),i.natfid=new L.LatLng(0,90),i.celpole=i.crval},project:function(i,t){var e=this._raDecToPhiTheta(i,t);return e.lat=t.projection.thetaToR(e.lat),this._redToPix(this._phiRToRed(e),t)},unproject:function(i,t){var e=this._redToPhiR(this._pixToRed(i,t));return e.lat=t.projection.rToTheta(e.lat),this._phiThetaToRADec(e,t)},_redToPhiR:function(i){return new L.LatLng(Math.sqrt(i.x*i.x+i.y*i.y),Math.atan2(i.x,-i.y)*L.LatLng.RAD_TO_DEG)},_phiRToRed:function(i){var t=L.LatLng.DEG_TO_RAD,e=i.lng*t;return new L.Point(i.lat*Math.sin(e),-i.lat*Math.cos(e))}}),L.Projection.WCS.TAN=L.extend({},L.Projection.WCS.zenithal,{code:"TAN",rToTheta:function(i){return Math.atan2(180,Math.PI*i)*L.LatLng.RAD_TO_DEG},thetaToR:function(i){return 180/Math.PI*Math.tan((90-i)*L.LatLng.DEG_TO_RAD)}}),L.Projection.WCS.ZEA=L.extend({},L.Projection.WCS.zenithal,{code:"ZEA",rToTheta:function(i){return 90-2*Math.asin(Math.PI*i/360)*L.LatLng.RAD_TO_DEG},thetaToR:function(i){return 360/Math.PI*Math.sin(.5*(90-i)*L.LatLng.DEG_TO_RAD)}}),L.CRS.WCS=L.extend({},L.CRS,{projparam:{projection:L.Projection.WCS.TAN,ctype:{x:"RA--TAN",y:"DEC--TAN"},naxis:new L.point(256,256,!0),nzoom:1,crpix:L.point(129,129),crval:L.latLng(0,0),cd:[[1,0],[0,1]],natpole:L.latLng(90,180),tileSize:L.point(256,256),celpole:L.latLng(0,0),natfid:L.latLng(0,90),cdinv:[[1,0],[0,1]]},initialize:function(){var i=this.projparam;this.transformation=new L.Transformation(1,-1,-1,i.naxis.y),i.projection.paraminit(i),this.code+=":"+i.projection.code,this.ready=!0},code:"WCS",projection:L.Projection.WCS,latLngToPoint:function(i,t){this.ready||this.initialize();var e=this.projparam.projection.project(i,this.projparam),o=this.scale(t);return this.transformation._transform(e,o)},pointToLatLng:function(i,t){this.ready||this.initialize();var e=this.scale(t),o=this.transformation.untransform(i,e);return this.projparam.projection.unproject(o,this.projparam)},project:function(i){return this.ready||this.initialize(),this.projparam.projection.project(i,this.projparam)},scale:function(i){return Math.pow(2,i-this.projparam.nzoom+1)},zoom1:function(i,t){return Math.ceil(Math.log(Math.max(i.x/t.x,i.y/t.y))/Math.LN2)}}),L.TileLayer.IIP=L.TileLayer.extend({options:{minZoom:0,maxZoom:18,continuousWorld:!1,noWrap:!0,contrast:1,gamma:1,unloadInvisibleTiles:L.Browser.mobile,updateWhenIdle:L.Browser.mobile},initialize:function(i,t){t=L.setOptions(this,t),t.detectRetina&&L.Browser.retina&&t.maxZoom>0&&(t.tileSize=Math.floor(t.tileSize/2),t.zoomOffset++,t.minZoom>0&&t.minZoom--,this.options.maxZoom--),this._url=i;var e=this.options.subdomains;"string"==typeof e&&(this.options.subdomains=e.split("")),this.iipTileSize={x:512,y:512},this.iipImageSize=[],this.iipImageSize[0]=this.iipTileSize,this.iipGridSize=[],this.iipGridSize[0]={x:1,y:1},this.iipMinZoom=this.iipMaxZoom=0,this.iipContrast=this.options.contrast,this.iipGamma=this.options.gamma,this.iipMinValue=[],this.iipMaxValue=[],this.iipMinValue[0]=0,this.iipMaxValue[0]=255,this.getIIPMetaData(i)},getIIPMetaData:function(i){this.requestURI(i.replace(/\&.*$/g,"")+"&obj=IIP,1.0&obj=Max-size&obj=Tile-size"+"&obj=Resolution-number&obj=Min-Max-sample-values","getting IIP metadata",this._parseMetadata,this)},requestURI:function(i,t,e){var o,a=this;if(window.XMLHttpRequest)o=new XMLHttpRequest;else if(window.ActiveXObject)try{o=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){try{o=new ActiveXObject("Microsoft.XMLHTTP")}catch(n){}}return o?(o.onreadystatechange=function(){e(a,o)},o.open("GET",i),o.send(),void 0):(alert("Giving up: Cannot create an XMLHTTP instance for "+t),!1)},_parseMetadata:function(i,t){if(4===t.readyState)if(200===t.status){var e=t.responseText,o=e.split("Max-size");o[1]||alert("Error: Unexpected response from IIP server "+i._url.replace(/\?.*$/g,""));var a=o[1].split(" "),n={x:parseInt(a[0].substring(1,a[0].length),10),y:parseInt(a[1],10)};o=e.split("Tile-size"),a=o[1].split(" "),i.iipTileSize={x:parseInt(a[0].substring(1,a[0].length),10),y:parseInt(a[1],10)},o=e.split("Resolution-number");for(var r=parseInt(o[1].substring(1,o[1].length),10)-1,s={x:2,y:2},l=0;r>=l&&s.x>1&&s.y>1;l++){var p={x:Math.floor(n.x/Math.pow(2,r+l)),y:Math.floor(n.y/Math.pow(2,r+l))};s={x:Math.ceil(p.x/i.iipTileSize.x),y:Math.ceil(p.y/i.iipTileSize.y)}}for(i.iipMinZoom=l-1,i.iipMinZoom>i.options.minZoom&&(i.options.minZoom=i.iipMinZoom),i.iipMaxZoom=i.iipMinZoom+r,i.options.maxZoom||(i.options.maxZoom=i.iipMaxZoom+2),i.options.maxNativeZoom||(i.options.maxNativeZoom=i.iipMaxZoom),l=0;l<=i.iipMaxZoom;l++)i.iipImageSize[l]={x:Math.floor(n.x/Math.pow(2,i.iipMaxZoom-l)),y:Math.floor(n.y/Math.pow(2,i.iipMaxZoom-l))},i.iipGridSize[l]={x:Math.ceil(i.iipImageSize[l].x/i.iipTileSize.x),y:Math.ceil(i.iipImageSize[l].y/i.iipTileSize.y)};for(l=i.iipMaxZoom;l<=i.options.maxZoom;l++)i.iipGridSize[l]=i.iipGridSize[i.iipMaxZoom];o=e.split("Min-Max-sample-values:"),o[1]||alert("Error: Unexpected response from server "+this.server);for(var h=o[1].split(" "),c=Math.floor(h.length/2),u=0,m=0;m<h.length,c>u;m++)""!==h[m]&&(i.iipMinValue[u]=parseFloat(h[m]),u++);for(var d=0,_=m;_<h.length;_++)""!==h[m]&&(i.iipMaxValue[d]=parseFloat(h[m]),d++);i.options.bounds&&(i.options.bounds=L.latLngBounds(i.options.bounds)),i.iipMetaReady=!0,i.fire("metaload")}else alert("There was a problem with the IIP metadata request.")},addTo:function(i){return this.iipMetaReady?i.addLayer(this):(this._premap=i,this.once("metaload",this._addToMap,this)),this},_addToMap:function(){this._premap.addLayer(this),this._premap=void 0},_getTileSizeFac:function(){var i=this._map,t=i.getZoom(),e=this.options.maxNativeZoom;return e&&t>e?Math.round(i.getZoomScale(t)/i.getZoomScale(e)):1},_getTileSize:function(){var i=this._getTileSizeFac();return{x:this.iipTileSize.x*i,y:this.iipTileSize.y*i}},_update:function(){if(this._map){var i=this._map,t=i.getPixelBounds(),e=i.getZoom(),o=this._getTileSize();if(!(e>this.options.maxZoom||e<this.options.minZoom)){var a=L.bounds(this._vecDiv(t.min.clone(),o)._floor(),this._vecDiv(t.max.clone(),o)._floor());this._addTilesFromCenterOut(a),(this.options.unloadInvisibleTiles||this.options.reuseTiles)&&this._removeOtherTiles(a)}}},_vecDiv:function(i,t){return i.x/=t.x,i.y/=t.y,i},_vecMul:function(i,t){return i.x*=t.x,i.y*=t.y,i},_tileShouldBeLoaded:function(i){if(i.x+":"+i.y in this._tiles)return!1;var t=this._getZoomForUrl();if(i.x>=this.iipGridSize[t].x||i.y>=this.iipGridSize[t].y)return!1;var e=this.options;if(!e.continuousWorld){var o=this._getWrapTileNum();if(e.noWrap&&(i.x<0||i.x>=o)||i.y<0||i.y>=o)return!1}if(e.bounds){var a=this.iipTileSize,n=this._vecMul(i.clone(),a),r=n.add(a),s=this._map.unproject(n),l=this._map.unproject(r);if(e.continuousWorld||e.noWrap||(s=s.wrap(),l=l.wrap()),!e.bounds.intersects([s,l]))return!1}return!0},_getTilePos:function(i){var t=this._map.getPixelOrigin(),e=this._getTileSize();return this._vecMul(i.clone(),e).subtract(t)},getTileUrl:function(i){return L.Util.template(this._url,L.extend({s:this._getSubdomain(i),z:i.z-this.iipMinZoom,c:this.iipContrast,g:this.iipGamma,m:this.iipMinValue,M:this.iipMaxValue,t:i.x+this.iipGridSize[i.z].x*i.y},this.options))},_createTile:function(){var i=L.DomUtil.create("img","leaflet-tile");if(this._getTileSizeFac()>1){var t=this._getTileSize();L.Browser.ie?i.style.msInterpolationMode="nearest-neighbor":i.style.imageRendering=L.Browser.chrome?"-webkit-optimize-speed":"-moz-crisp-edges",i.style.width=t.x+"px",i.style.height=t.y+"px"}return i.galleryimg="no",i.onselectstart=i.onmousemove=L.Util.falseFn,L.Browser.ielt9&&void 0!==this.options.opacity&&L.DomUtil.setOpacity(i,this.options.opacity),i}}),L.tileLayer.iip=function(i,t){return new L.TileLayer.IIP(i,t)},L.Control.IIP=L.Control.extend({options:{title:"a control related to IIPImage",collapsed:!0,position:"topleft"},initialize:function(i,t){L.setOptions(this,t),this._className="leaflet-control-iipimage",this._layers=i},onAdd:function(){var i=this._className,t=this._container=L.DomUtil.create("div",i+" leaflet-bar");if(t.setAttribute("aria-haspopup",!0),L.Browser.touch?L.DomEvent.on(t,"click",L.DomEvent.stopPropagation):(L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"mousewheel",L.DomEvent.stopPropagation)),this._dialog=L.DomUtil.create("div",i+"-dialog",t),this.options.collapsed){L.Browser.android||L.DomEvent.on(t,"mouseover",this._expand,this).on(t,"mouseout",this._collapse,this);var e=this._link=L.DomUtil.create("a",i+"-button leaflet-bar",t);e.href="#",e.title=this.options.title,L.Browser.touch?L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",this._expand,this):L.DomEvent.on(e,"focus",this._expand,this),this._map.on("click",this._collapse,this)}else this._expand();return this._checkLayer(),this._container},_checkLayer:function(){var i=this._layer=this._findActiveBaseLayer();i?this._initDialog():this._prelayer&&this._prelayer.once("metaload",this._checkLayer,this)},_initDialog:function(){this._className,this._container,this._dialog,this._link,this._layer},_expand:function(){L.DomUtil.addClass(this._container,this._className+"-expanded")},_collapse:function(){this._container.className=this._container.className.replace(" "+this._className+"-expanded","")},getActiveBaseLayer:function(){return this._activeBaseLayer},_findActiveBaseLayer:function(){var i=this._layers;this._prelayer=void 0;for(var t in i){var e=i[t];if(!e.overlay)if(e._premap)this._prelayer=e;else if(this._map.hasLayer(e)&&e.iipContrast)return e}return void 0},_onInputChange:function(i,t){var e=t.split(/\[|\]/);e[1]?i.layer[e[0]][parseInt(e[1],10)]=i.value:i.layer[e[0]]=i.value,i.layer.redraw()}}),L.control.iip=function(i,t){return new L.Control.IIP(i,t)},"undefined"!=typeof require)var $=require("jquery-browser");L.Control.IIP.Image=L.Control.IIP.extend({options:{title:"Image adjustment",collapsed:!0,position:"topleft"},initialize:function(i,t){L.setOptions(this,t),this._className="leaflet-control-iipimage",this._layers=i},_initDialog:function(){var i=this,t=this._className,e=this._dialog,o=this._layer;this._min=L.DomUtil.create("div",t+"-min",e),this._max=L.DomUtil.create("div",t+"-max",e),this._separator=L.DomUtil.create("div",t+"-separator",e);var a=((o.iipMaxValue[0]-o.iipMinValue[0])/100).toPrecision(1),n=document.createElement("input");n.className="leaflet-minValue",n.type="text",n.value=String(o.iipMinValue[0]),n.layer=o,this._min.appendChild(n),$(".leaflet-minValue").spinner({stop:function(){i._onInputChange(n,"iipMinValue[0]")},icons:{down:"icon-minus",up:"icon-plus"},step:a}),L.DomEvent.on(n,"change",function(){i._onInputChange(n,"iipMinValue[0]")},this);var r=document.createElement("input");r.className="leaflet-maxValue",r.type="text",r.value=String(o.iipMaxValue[0]),r.layer=o,this._max.appendChild(r),$(".leaflet-maxValue").spinner({stop:function(){i._onInputChange(r,"iipMaxValue[0]")},icons:{down:"icon-minus",up:"icon-plus"},step:a}),L.DomEvent.on(r,"change",function(){i._onInputChange(r,"iipMaxValue[0]")},this)}}),L.control.iip.image=function(i,t){return new L.Control.IIP.Image(i,t)},L.Control.IIP.Plot=L.Control.IIP.extend({options:{title:"Image adjustment",collapsed:!0,position:"topleft"},initialize:function(i,t){L.setOptions(this,t),this._className="leaflet-control-iipplot",this._layers=i},_initDialog:function(){var i=this._className,t=this._dialog,e=this._layer;this._profile=L.DomUtil.create("div",i+"-profile",t);var o=document.createElement("input");o.className="leaflet-profile",o.type="button",o.layer=e,this._profile.appendChild(o),L.DomEvent.on(o,"click",this.getProfile,this)},getProfile:function(){this._layer.requestURI(this._layer._url.replace(/\&.*$/g,"")+"&PFL=9:20,100-9000,2000","getting IIP layer profile",this._parseProfile,this)},_parseProfile:function(i,t){4===t.readyState&&200===t.status&&t.responseText}}),L.control.iip.plot=function(i,t){return new L.Control.IIP.Plot(i,t)};