/*
#	Copyright:    (C) 2013 Emmanuel Bertin - IAP/CNRS/UPMC
#                        Chiara Marmo - IDES/Paris-Sud,
#                        Ruven Pillay - C2RMF/CNRS
#
#	License:		GNU General Public License
#
#	This Leaflet plug-in is free software: you can redistribute it and/or modify
#	it under the terms of the GNU General Public License as published by
#	the Free Software Foundation, either version 3 of the License, or
# 	(at your option) any later version.
#	This plug-in is distributed in the hope that it will be useful,
#	but WITHOUT ANY WARRANTY; without even the implied warranty of
#	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#	GNU General Public License for more details.
#	You should have received a copy of the GNU General Public License
#	along with this plug-in. If not, see <http://www.gnu.org/licenses/>.
*/

if(L.IIPUtils={requestURI:function(t,e,i,a){var o;if(window.XMLHttpRequest)o=new XMLHttpRequest;else if(window.ActiveXObject)try{o=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){try{o=new ActiveXObject("Microsoft.XMLHTTP")}catch(n){}}return o?(o.open("GET",t),o.onreadystatechange=function(){i(a,o)},o.send(),void 0):(alert("Giving up: Cannot create an XMLHTTP instance for "+e),!1)}},L.Projection.WCS={_phiThetaToRADec:function(t,e){var i=L.LatLng.DEG_TO_RAD,a=L.LatLng.RAD_TO_DEG,o=t.lat*i,n=Math.cos(o),r=Math.sin(o),s=e.celpole.lat*i,l=Math.cos(s),p=Math.sin(s),c=(t.lng-e.natpole.lng)*i,h=Math.cos(c);return new L.LatLng(Math.asin(r*p+n*l*h)*a,e.celpole.lng+Math.atan2(-n*Math.sin(c),r*l-n*p*h)*a)},_raDecToPhiTheta:function(t,e){var i=L.LatLng.DEG_TO_RAD,a=L.LatLng.RAD_TO_DEG,o=(t.lng-e.celpole.lng)*i,n=Math.cos(o),r=Math.sin(o),s=t.lat*i,l=Math.cos(s),p=Math.sin(s),c=e.celpole.lat*i,h=Math.cos(c),u=Math.sin(c);return new L.LatLng(Math.asin(p*u+l*h*n)*a,e.natpole.lng+Math.atan2(-l*r,p*h-l*u*n)*a)},_pixToRed:function(t,e){var i=e.cd,a=t.subtract(e.crpix);return new L.Point(a.x*i[0][0]+a.y*i[0][1],a.x*i[1][0]+a.y*i[1][1])},_redToPix:function(t,e){var i=e.cdinv;return new L.point(t.x*i[0][0]+t.y*i[0][1],t.x*i[1][0]+t.y*i[1][1]).add(e.crpix)},_invertCD:function(t){var e=1/(t[0][0]*t[1][1]-t[0][1]*t[1][0]);return[[t[1][1]*e,-t[0][1]*e],[-t[1][0]*e,t[0][0]*e]]}},L.Projection.WCS.zenithal=L.extend({},L.Projection.WCS,{paraminit:function(t){t.cdinv=this._invertCD(t.cd),t.natfid=new L.LatLng(0,90),t.celpole=t.crval},project:function(t,e){var i=this._raDecToPhiTheta(t,e);return i.lat=e.projection.thetaToR(i.lat),this._redToPix(this._phiRToRed(i),e)},unproject:function(t,e){var i=this._redToPhiR(this._pixToRed(t,e));return i.lat=e.projection.rToTheta(i.lat),this._phiThetaToRADec(i,e)},_redToPhiR:function(t){return new L.LatLng(Math.sqrt(t.x*t.x+t.y*t.y),Math.atan2(t.x,-t.y)*L.LatLng.RAD_TO_DEG)},_phiRToRed:function(t){var e=L.LatLng.DEG_TO_RAD,i=t.lng*e;return new L.Point(t.lat*Math.sin(i),-t.lat*Math.cos(i))}}),L.Projection.WCS.TAN=L.extend({},L.Projection.WCS.zenithal,{code:"TAN",rToTheta:function(t){return Math.atan2(180,Math.PI*t)*L.LatLng.RAD_TO_DEG},thetaToR:function(t){return 180/Math.PI*Math.tan((90-t)*L.LatLng.DEG_TO_RAD)}}),L.Projection.WCS.ZEA=L.extend({},L.Projection.WCS.zenithal,{code:"ZEA",rToTheta:function(t){return 90-2*Math.asin(Math.PI*t/360)*L.LatLng.RAD_TO_DEG},thetaToR:function(t){return 360/Math.PI*Math.sin(.5*(90-t)*L.LatLng.DEG_TO_RAD)}}),L.CRS.WCS=L.extend({},L.CRS,{projparam:{projection:L.Projection.WCS.TAN,ctype:{x:"RA--TAN",y:"DEC--TAN"},naxis:new L.point(256,256,!0),nzoom:1,crpix:L.point(129,129),crval:L.latLng(0,0),cd:[[1,0],[0,1]],natpole:L.latLng(90,180),tileSize:L.point(256,256),celpole:L.latLng(0,0),natfid:L.latLng(0,90),cdinv:[[1,0],[0,1]]},initialize:function(){var t=this.projparam;this.transformation=new L.Transformation(1,-1,-1,t.naxis.y),t.projection.paraminit(t),this.code+=":"+t.projection.code,this.ready=!0},code:"WCS",projection:L.Projection.WCS,latLngToPoint:function(t,e){this.ready||this.initialize();var i=this.projparam.projection.project(t,this.projparam),a=this.scale(e);return this.transformation._transform(i,a)},pointToLatLng:function(t,e){this.ready||this.initialize();var i=this.scale(e),a=this.transformation.untransform(t,i);return this.projparam.projection.unproject(a,this.projparam)},project:function(t){return this.ready||this.initialize(),this.projparam.projection.project(t,this.projparam)},scale:function(t){return Math.pow(2,t-this.projparam.nzoom+1)},zoom1:function(t,e){return Math.ceil(Math.log(Math.max(t.x/e.x,t.y/e.y))/Math.LN2)},distance:function(t,e){var i=L.LatLng.DEG_TO_RAD,a=t.lat*i,o=e.lat*i,n=o-a,r=(e.lng-t.lng)*i,s=Math.sin(n/2),l=Math.sin(r/2),p=s*s+l*l*Math.cos(a)*Math.cos(o);return 2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p))*L.LatLng.RAD_TO_DEG}}),L.TileLayer.IIP=L.TileLayer.extend({options:{minZoom:0,maxZoom:18,continuousWorld:!1,noWrap:!0,contrast:1,gamma:1,cMap:"grey",unloadInvisibleTiles:L.Browser.mobile,updateWhenIdle:L.Browser.mobile},iip:{TileSize:{x:512,y:512},ImageSize:[],GridSize:[],BPP:8,MinZoom:0,MaxZoom:0,Contrast:1,Gamma:1,CMap:"grey",MinValue:[],MaxValue:[],Quality:90},iipdefault:{Contrast:1,Gamma:1,CMap:"grey",MinValue:[],MaxValue:[],Quality:90},initialize:function(t,e){e=L.setOptions(this,e),e.detectRetina&&L.Browser.retina&&e.maxZoom>0&&(e.tileSize=Math.floor(e.tileSize/2),e.zoomOffset++,e.minZoom>0&&e.minZoom--,this.options.maxZoom--),this._url=t.replace(/\&.*$/g,"");var i=this.options.subdomains;"string"==typeof i&&(this.options.subdomains=i.split("")),this.iip.ImageSize[0]=this.iip.TileSize,this.iip.GridSize[0]={x:1,y:1},this.iip.Contrast=this.options.contrast,this.iip.Gamma=this.options.gamma,this.iip.MinValue[0]=0,this.iip.MaxValue[0]=255,this.getIIPMetaData(this._url)},getIIPMetaData:function(t){L.IIPUtils.requestURI(t+"&obj=IIP,1.0&obj=max-size&obj=tile-size"+"&obj=resolution-number&obj=bits-per-channel"+"&obj=min-max-sample-values","getting IIP metadata",this._parseMetadata,this)},_parseMetadata:function(t,e){if(4===e.readyState)if(200===e.status){var i=e.responseText,a=i.split("Max-size");a[1]||alert("Error: Unexpected response from IIP server "+t._url.replace(/\?.*$/g,""));var o=a[1].split(" "),n={x:parseInt(o[0].substring(1,o[0].length),10),y:parseInt(o[1],10)};a=i.split("Tile-size"),o=a[1].split(" "),t.iip.TileSize={x:parseInt(o[0].substring(1,o[0].length),10),y:parseInt(o[1],10)},a=i.split("Resolution-number");for(var r=parseInt(a[1].substring(1,a[1].length),10)-1,s={x:2,y:2},l=0;r>=l&&s.x>1&&s.y>1;l++){var p={x:Math.floor(n.x/Math.pow(2,r+l)),y:Math.floor(n.y/Math.pow(2,r+l))};s={x:Math.ceil(p.x/t.iip.TileSize.x),y:Math.ceil(p.y/t.iip.TileSize.y)}}for(t.iip.MinZoom=l-1,t.iip.MinZoom>t.options.minZoom&&(t.options.minZoom=t.iip.MinZoom),t.iip.MaxZoom=t.iip.MinZoom+r,t.options.maxZoom||(t.options.maxZoom=t.iip.MaxZoom+2),t.options.maxNativeZoom||(t.options.maxNativeZoom=t.iip.MaxZoom),l=0;l<=t.iip.MaxZoom;l++)t.iip.ImageSize[l]={x:Math.floor(n.x/Math.pow(2,t.iip.MaxZoom-l)),y:Math.floor(n.y/Math.pow(2,t.iip.MaxZoom-l))},t.iip.GridSize[l]={x:Math.ceil(t.iip.ImageSize[l].x/t.iip.TileSize.x),y:Math.ceil(t.iip.ImageSize[l].y/t.iip.TileSize.y)};for(l=t.iip.MaxZoom;l<=t.options.maxZoom;l++)t.iip.GridSize[l]=t.iip.GridSize[t.iip.MaxZoom];a=i.split("Bits-per-channel"),t.iip.BPP=parseInt(a[1].substring(1,a[1].length),10),t.iip.Gamma=t.iip.BPP>=32?2.2:1,a=i.split("Min-Max-sample-values:"),a[1]||alert("Error: Unexpected response from server "+this.server);for(var c=a[1].split(" "),h=Math.floor(c.length/2),u=0,m=0;m<c.length,h>u;m++)""!==c[m]&&(t.iipdefault.MinValue[u]=t.iip.MinValue[u]=parseFloat(c[m]),u++);for(var d=0,g=m;g<c.length;g++)""!==c[m]&&(t.iipdefault.MaxValue[d]=t.iip.MaxValue[d]=parseFloat(c[m]),d++);t.options.bounds&&(t.options.bounds=L.latLngBounds(t.options.bounds)),t.iip.MetaReady=!0,t.fire("metaload")}else alert("There was a problem with the IIP metadata request.")},addTo:function(t){return this.iip.MetaReady?t.addLayer(this):(this._premap=t,this.once("metaload",this._addToMap,this)),this},_addToMap:function(){this._premap.addLayer(this),this._premap=void 0},_getTileSizeFac:function(){var t=this._map,e=t.getZoom(),i=this.options.maxNativeZoom;return i&&e>i?Math.round(t.getZoomScale(e)/t.getZoomScale(i)):1},_getTileSize:function(){var t=this._getTileSizeFac();return{x:this.iip.TileSize.x*t,y:this.iip.TileSize.y*t}},_update:function(){if(this._map){var t=this._map,e=t.getPixelBounds(),i=t.getZoom(),a=this._getTileSize();if(!(i>this.options.maxZoom||i<this.options.minZoom)){var o=L.bounds(this._vecDiv(e.min.clone(),a)._floor(),this._vecDiv(e.max.clone(),a)._floor());this._addTilesFromCenterOut(o),(this.options.unloadInvisibleTiles||this.options.reuseTiles)&&this._removeOtherTiles(o)}}},_vecDiv:function(t,e){return t.x/=e.x,t.y/=e.y,t},_vecMul:function(t,e){return t.x*=e.x,t.y*=e.y,t},_tileShouldBeLoaded:function(t){if(t.x+":"+t.y in this._tiles)return!1;var e=this._getZoomForUrl();if(t.x>=this.iip.GridSize[e].x||t.y>=this.iip.GridSize[e].y)return!1;var i=this.options;if(!i.continuousWorld){var a=this._getWrapTileNum();if(i.noWrap&&(t.x<0||t.x>=a)||t.y<0||t.y>=a)return!1}if(i.bounds){var o=this.iip.TileSize,n=this._vecMul(t.clone(),o),r=n.add(o),s=this._map.unproject(n),l=this._map.unproject(r);if(i.continuousWorld||i.noWrap||(s=s.wrap(),l=l.wrap()),!i.bounds.intersects([s,l]))return!1}return!0},_getTilePos:function(t){var e=this._map.getPixelOrigin(),i=this._getTileSize();return this._vecMul(t.clone(),i).subtract(e)},getTileUrl:function(t){var e=this._url;return this.iip.CMap!==this.iipdefault.CMap&&(e+="&CMP="+this.iip.CMap),this.iip.Contrast!==this.iipdefault.Contrast&&(e+="&CNT="+this.iip.Contrast.toString()),this.iip.Gamma!==this.iipdefault.Gamma&&(e+="&GAM="+(1/this.iip.Gamma).toFixed(4)),(this.iip.MinValue[0]!==this.iipdefault.MinValue[0]||this.iip.MaxValue[0]!==this.iipdefault.MaxValue[0])&&(e+="&MINMAX=1,"+this.iip.MinValue[0].toString()+","+this.iip.MaxValue[0].toString()),this.iip.Quality!==this.iipdefault.Quality&&(e+="&QLT="+this.iip.Quality.toString()),e+"&JTL="+(t.z-this.iip.MinZoom).toString()+","+(t.x+this.iip.GridSize[t.z].x*t.y).toString()},_createTile:function(){var t=L.DomUtil.create("img","leaflet-tile");if(this._getTileSizeFac()>1){var e=this._getTileSize();L.Browser.ie?t.style.msInterpolationMode="nearest-neighbor":t.style.imageRendering=L.Browser.chrome?"-webkit-optimize-speed":"-moz-crisp-edges",t.style.width=e.x+"px",t.style.height=e.y+"px"}return t.galleryimg="no",t.onselectstart=t.onmousemove=L.Util.falseFn,L.Browser.ielt9&&void 0!==this.options.opacity&&L.DomUtil.setOpacity(t,this.options.opacity),t}}),L.tileLayer.iip=function(t,e){return new L.TileLayer.IIP(t,e)},L.Control.IIP=L.Control.extend({options:{title:"a control related to IIPImage",collapsed:!0,position:"topleft"},initialize:function(t,e){L.setOptions(this,e),this._className="leaflet-control-iipimage",this._layers=t},onAdd:function(){var t=this._className,e=this._container=L.DomUtil.create("div",t+" leaflet-bar");if(e.setAttribute("aria-haspopup",!0),L.Browser.touch?L.DomEvent.on(e,"click",L.DomEvent.stopPropagation):(L.DomEvent.disableClickPropagation(e),L.DomEvent.on(e,"mousewheel",L.DomEvent.stopPropagation)),this._dialog=L.DomUtil.create("div",t+"-dialog",e),this.options.collapsed){L.Browser.android||L.DomEvent.on(e,"mouseover",this._expand,this).on(e,"mouseout",this._collapse,this);var i=this._toggle=L.DomUtil.create("a",t+"-toggle leaflet-bar",e);i.href="#",i.title=this.options.title,L.Browser.touch?L.DomEvent.on(i,"click",L.DomEvent.stop).on(i,"click",this._expand,this):L.DomEvent.on(i,"focus",this._expand,this),this._map.on("click",this._collapse,this)}else this._expand();return this._checkLayer(),this._container},_checkLayer:function(){var t=this._layer=this._findActiveBaseLayer();t?this._initDialog():this._prelayer&&this._prelayer.once("metaload",this._checkLayer,this)},_initDialog:function(){this._className,this._container,this._dialog,this._toggle,this._layer},_expand:function(){L.DomUtil.addClass(this._container,this._className+"-expanded")},_collapse:function(){this._container.className=this._container.className.replace(" "+this._className+"-expanded","")},getActiveBaseLayer:function(){return this._activeBaseLayer},_findActiveBaseLayer:function(){var t=this._layers;this._prelayer=void 0;for(var e in t){var i=t[e];if(!i.overlay)if(i._premap)this._prelayer=i;else if(this._map.hasLayer(i)&&i.iip)return i}return void 0},_onInputChange:function(t,e,i){var a=e.split(/\[|\]/);a[1]?t.layer.iip[a[0]][parseInt(a[1],10)]=i:t.layer.iip[a[0]]=i,t.layer.redraw()}}),L.control.iip=function(t,e){return new L.Control.IIP(t,e)},"undefined"!=typeof require)var $=require("jquery-browser");L.Control.IIP.Image=L.Control.IIP.extend({options:{title:"Image adjustment",collapsed:!0,cmap:"grey",position:"topleft"},initialize:function(t,e){L.setOptions(this,e),this._className="leaflet-control-iipimage",this._layers=t},_initDialog:function(){var t,e=this,i=this._className,a=this._dialog,o=this._layer,n=["grey","jet","cold","hot"];t=this._addDialogLine("LUT:");var r=L.DomUtil.create("span",i+"-cmaps",t);for(var s in n){var l=document.createElement("input");l.className="leaflet-cmap-"+n[s],l.type="button",l.name="button",l.cmap=n[s],l.layer=o,r.appendChild(l),n[s]===this.options.cmap&&(l.checked="checked")}$("."+i+"-cmaps").buttonset(),$("."+i+"-cmaps :button").click(function(){e._onInputChange(this,"CMap",this.cmap)}),this._separator=L.DomUtil.create("div",i+"-separator",a);var p=((o.iip.MaxValue[0]-o.iip.MinValue[0])/100).toPrecision(1);t=this._addDialogLine("Min:");var c=L.DomUtil.create("input","",t);c.id="leaflet-minvalue",c.type="text",c.value=String(o.iip.MinValue[0]),c.layer=o,$("#leaflet-minvalue").spinner({stop:function(){e._onInputChange(c,"MinValue[0]",c.value)},icons:{down:"icon-minus",up:"icon-plus"},step:p}),L.DomEvent.on(c,"change",function(){e._onInputChange(c,"MinValue[0]",c.value)},this),t=this._addDialogLine("Max:");var h=L.DomUtil.create("input","",t);h.id="leaflet-maxvalue",h.type="text",h.value=String(o.iip.MaxValue[0]),h.layer=o,$("#leaflet-maxvalue").spinner({stop:function(){e._onInputChange(h,"MaxValue[0]",h.value)},icons:{down:"icon-minus",up:"icon-plus"},step:p}),L.DomEvent.on(h,"change",function(){e._onInputChange(h,"MaxValue[0]",h.value)},this),t=this._addDialogLine("Gamma:");var u=L.DomUtil.create("input","",t);u.id="leaflet-gammavalue",u.type="text",u.value=String(o.iip.Gamma),u.layer=o,$("#leaflet-gammavalue").spinner({stop:function(){e._onInputChange(h,"Gamma",u.value)},icons:{down:"icon-minus",up:"icon-plus"},step:.05,min:.5,max:5}),L.DomEvent.on(u,"change",function(){e._onInputChange(u,"Gamma",u.value)},this),t=this._addDialogLine("Contrast:");var m=L.DomUtil.create("input","",t);m.id="leaflet-contrastvalue",m.type="text",m.value=String(o.iip.Contrast),m.layer=o,$("#leaflet-contrastvalue").spinner({stop:function(){e._onInputChange(h,"Contrast",m.value)},icons:{down:"icon-minus",up:"icon-plus"},step:.05,min:0,max:10}),L.DomEvent.on(m,"change",function(){e._onInputChange(m,"Contrast",m.value)},this),t=this._addDialogLine("JPEG quality:");var d=L.DomUtil.create("input","",t);d.id="leaflet-qualvalue",d.type="text",d.value=String(o.iip.Quality),d.layer=o,$("#leaflet-qualvalue").spinner({stop:function(){e._onInputChange(h,"Quality",d.value)},icons:{down:"icon-minus",up:"icon-plus"},step:1,min:0,max:100}),L.DomEvent.on(d,"change",function(){e._onInputChange(d,"quality",d.value)},this)},_addDialogLine:function(t){var e=L.DomUtil.create("div",this._className+"-element",this._dialog),i=L.DomUtil.create("span",this._className+"-label",e);return i.innerHTML=t,e}}),L.control.iip.image=function(t,e){return new L.Control.IIP.Image(t,e)},L.Draw.Line=L.Draw.Polyline.extend({_updateFinishHandler:function(){var t=this._markers.length;t>1&&this._markers[t-1].on("click",this._finishShape,this),t>2&&this._markers[t-2].off("click",this._finishShape,this),t>=2&&this._finishShape()},_getMeasurementString:function(){var t,e,i,a=this._currentLatLng,o=this._markers[this._markers.length-1].getLatLng();return t=this._measurementRunningTotal+L.CRS.WCS.distance(a,o),t>=1?i="&#176;":(t*=60,t>=1?i="&#39;":(t*=60,i="&#34;")),e=t.toFixed(2)+i}}),L.Control.IIP.Plot=L.Control.IIP.extend({options:{title:"Image adjustment",collapsed:!0,position:"topleft"},initialize:function(t,e){L.setOptions(this,e),this._className="leaflet-control-iipplot",this._layers=t},_initDialog:function(){var t=this._className,e=this._dialog,i=this._layer;this._profile=L.DomUtil.create("div",t+"-profile",e);var a=document.createElement("input");a.className="leaflet-profile",a.type="button",a.layer=i,this._profile.appendChild(a),L.DomEvent.on(a,"click",this.getProfile,this)},getProfile:function(){L.drawLocal.draw.handlers.polyline.tooltip.cont="Click to end drawing line.";var t=new L.Draw.Line(this._map),e=this;this._map.on("draw:created",function(i){var a=i.layer;e._map.addLayer(a),t.removeHooks(),console.log(a._latlngs)}),t.addHooks(),this._layer.requestURI(this._layer._url.replace(/\&.*$/g,"")+"&PFL=9:20,100-9000,2000","getting IIP layer profile",this._parseProfile,this)},_parseProfile:function(t,e){4===e.readyState&&200===e.status&&e.responseText}}),L.control.iip.plot=function(t,e){return new L.Control.IIP.Plot(t,e)},L.Catalog={_csvToGeoJSON:function(t){var e=new RegExp("#|--|^$"),i=t.split("\n"),a={type:"FeatureCollection",features:[]};for(var o in i){var n=i[o];if(e.test(n)===!1){var r={type:"Feature",id:"",properties:{mags:[]},geometry:{type:"Point",coordinates:[0,0]}},s=r.geometry,l=r.properties,p=n.split(";");r.id=p[0],s.coordinates[0]=parseFloat(p[1]),s.coordinates[1]=parseFloat(p[2]);var c=p.slice(3);for(var h in c)l.mags.push(parseFloat(c[h]));a.features.push(r)}}return a}},L.Catalog.TwoMASS=L.extend({},L.Catalog,{name:"2MASS point sources",attribution:"2MASS All-Sky Catalog of Point Sources (Cutri et al., 2003)",color:"red",maglim:17,service:"CDS",uri:"/viz-bin/asu-tsv?&-mime=csv&-source=II/246&-out=2MASS,RAJ2000,DEJ2000,Jmag,Hmag,Kmag&-out.meta=&-c={ra}%2b{dec},eq=J2000&-c.bd={dra},{ddec}",toGeoJSON:L.Catalog._csvToGeoJSON,properties:["Jmag","Hmag","Kmag"],objuri:"http://vizier.u-strasbg.fr/viz-bin/VizieR-5?-source=II/246&-c={ra}%2b{dec},eq=J2000&-c.rs=0.01"}),L.Catalog.SDSS=L.extend({},L.Catalog,{name:"SDSS release 9",attribution:"SDSS Photometric Catalog, Release 9 (Adelman-McCarthy et al., 2012)",color:"green",maglim:25,service:"CDS",uri:"/viz-bin/asu-tsv?&-mime=csv&-source=V/139&-out=SDSS9,RAJ2000,DEJ2000,umag,gmag,rmag,imag,zmag&-out.meta=&-c={ra},{dec}&-c.bd={dra},{ddec}",toGeoJSON:L.Catalog._csvToGeoJSON,properties:["umag","gmag","rmag","imag","zmag"],objuri:"http://vizier.u-strasbg.fr/viz-bin/VizieR-5?-source=V/139/sdss9&-c={ra}%2b{dec},eq=J2000&-c.rs=0.01"}),L.Control.Layers.Catalogs=L.Control.Layers.extend({options:{title:"overlay menu",collapsed:!0,position:"topright",newoverlay:{title:"Overlay menu",collapsed:!0}},_initLayout:function(){L.Control.Layers.prototype._initLayout.call(this);var t=this._newoverlay=L.DomUtil.create("div","leaflet-control-newoverlay",this._form);if(t.setAttribute("aria-haspopup",!0),L.Browser.touch?L.DomEvent.on(t,"click",L.DomEvent.stopPropagation):(L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"mousewheel",L.DomEvent.stopPropagation)),this._newoverlaydialog=L.DomUtil.create("div",t.className+"-dialog",t),this.options.newoverlay.collapsed){L.Browser.android||L.DomEvent.on(t,"mouseover",this._newoverlayexpand,this).on(t,"mouseout",this._newoverlaycollapse,this);var e=this._newoverlaytoggle=L.DomUtil.create("a",t.className+"-toggle",t);e.href="#",e.innerHTML="...",e.title=this.options.newoverlay.title,L.Browser.touch&&L.DomEvent.on(e,"click",L.DomEvent.stop),L.DomEvent.on(e,"click",this._newoverlayexpand,this),this._map.on("click",this._newoverlaycollapse,this)}else this._newoverlayexpand();this._initDialog()},_initDialog:function(){var t=this,e=this._newoverlaydialog;this._newoverlay.className;var i=document.createElement("input");i.className="leaflet-newoverlay-2mass leaflet-control-bar",i.type="button",e.appendChild(i),L.DomEvent.on(i,"click",function(){t.getCatalog(L.Catalog.TwoMASS)},this),i=document.createElement("input"),i.className="leaflet-newoverlay-sdss leaflet-control-bar",i.type="button",e.appendChild(i),L.DomEvent.on(i,"click",function(){t.getCatalog(L.Catalog.SDSS)},this)},_newoverlayexpand:function(){L.DomUtil.addClass(this._newoverlay,"leaflet-control-newoverlay-expanded")},_newoverlaycollapse:function(){this._newoverlay.className=this._newoverlay.className.replace(" leaflet-control-newoverlay-expanded","")},getCatalog:function(t){var e=this,i=this._map.getCenter(),a=this._map.getBounds(),o=Math.abs(Math.cos(i.lat))*L.LatLng.DEG_TO_RAD,n=Math.abs(a.getWest()-a.getEast()),r=Math.abs(a.getNorth()-a.getSouth());r>1?r=1:1e-4>r&&(r=1e-4),o>0&&(n*o>1?n=1/o:n*o>1&&(n=1/o)),L.IIPUtils.requestURI(L.Util.template(t.uri,L.extend({ra:i.lng.toFixed(6),dec:i.lat.toFixed(6),dra:n.toFixed(4),ddec:r.toFixed(4)})),"getting "+t.service+" data",function(i,a){e._loadCatalog(t,i,a)},this,!0)},_loadCatalog:function(t,e,i){if(4===i.readyState)if(200===i.status){var a=i.responseText,o=t.toGeoJSON(a);L.geoJson(o,{onEachFeature:function(i,a){i.properties&&i.properties.mags&&a.bindPopup(e._popup(i,t))},pointToLayer:function(e,i){return L.circleMarker(i,{radius:e.properties.mags[0]?8+t.maglim-e.properties.mags[0]:8})},style:function(){return{color:t.color}}}).addTo(e._map),e.addOverlay(o,t.name)}else alert("There was a problem with the request to "+t.service+".")},_popup:function(t,e){var i="<div>";i+=e.objuri?'ID: <a href="'+L.Util.template(e.objuri,L.extend({ra:t.geometry.coordinates[0].toFixed(6),dec:t.geometry.coordinates[1].toFixed(6)}))+'" target="_blank">'+t.id+"</a></div>":"ID: "+t.id+"</div>";for(var a in e.properties)i+="<div>"+e.properties[a]+": "+t.properties.mags[a].toString()+"</div>";return i}}),L.control.layers.catalogs=function(t,e){return new L.Control.Layers.Catalogs(t,e)},L.Control.WCS=L.Control.extend({options:{position:"bottomleft",units:"HMS"},onAdd:function(t){var e=this._reticle=L.DomUtil.create("div","leaflet-reticle",this._map._controlContainer),i=e.style;return i.position="absolute",i.left="50%",i.bottom="50%",i.textAlign="center",i.verticalAlign="middle",e.innerHTML="+",this._container=L.DomUtil.create("div","leaflet-control-wcs"),L.DomEvent.disableClickPropagation(this._container),this._container.innerHTML="",t.on("drag",this._onDrag,this),this._container},onRemove:function(t){t.off("drag",this._onDrag)},_onDrag:function(){this._container.innerHTML=this._latLngToHMSDMS(this._map.getCenter())},_latLngToHMSDMS:function(t){var e=(t.lng+360)/360;e=24*(e-Math.floor(e));var i=Math.floor(e),a=60*(e-i),o=Math.floor(a),n=60*(a-o);n>=60&&(o++,n=0),60===o&&(i++,o=0);var r=i.toString()+":"+o.toString()+":"+n.toFixed(3),s=Math.abs(t.lat),l=t.lat<0?"-":"+",p=Math.floor(s);return a=60*(s-p),o=Math.floor(a),n=60*(a-o),n>=60&&(o++,n=0),60===o&&(i++,o=0),r+l+p.toString()+":"+o.toString()+":"+n.toFixed(2)}}),L.Map.mergeOptions({positionControl:!1}),L.Map.addInitHook(function(){this.options.positionControl&&(this.positionControl=new L.Control.MousePosition,this.addControl(this.positionControl))}),L.control.wcs=function(t){return new L.Control.WCS(t)};